{% extends "base.html" %}
{% load static %}

{% block content %}
<h2>Add Purchase Logs</h2>

<form method="POST">
    {% csrf_token %}

    <table class="table">
        <tbody class="two-col-form">

        <!-- DATE -->
        <tr>
            <th scope="row" class="text-right">Date & Time:</th>
            <td class="form-input-td customer_search_area">
                <input type="datetime-local" value="{% now "Y-m-d H:i:s" %}" name="date">
            </td>
        </tr>
        
        <!-- VENDOR -->
        <tr>
            <th class="text-right">Vendor:</th>
            <td class="d-flex gap-2">
                <!-- Hidden field for submission -->
                <input type="hidden" name="vendor" id="vendorHidden" value="{{ form.vendor.value }}">
                <!-- Display input -->
                <input type="text" id="vendorDisplay" placeholder="Select Vendor" readonly>
                <button type="button" id="changeVendorBtn" class="btn btn-primary"><i class="fa fa-search"></i></button>
            </td>
        </tr>

        <!-- CHANGE IN BALANCE -->
        <tr>
            <th class="text-right">Change in balance:</th>
            <td>{{ form.change }}</td>
        </tr>

        <!-- CHANGE TYPE -->
        <tr>
            <th class="text-right">Change Type:</th>
            <td>{{ form.change_type }}</td>
        </tr>

        <!-- CATEGORY -->
        <tr>
            <th scope="row" class="text-right">Category:</th>
            <td>
                <select id="categorySelect" style="width: 200px;" onchange="toggleCategoryTextbox()" name="category">
                    <option value="">Other (Please specify)</option>
                    {% for category in categories %}
                        <option value="{{ category }}" {% if form.category.value == category %}selected{% endif %}>{{ category }}</option>
                    {% endfor %}
                </select>
            </td>
        </tr>
        <tr id="customCategoryRow" style="display: none;">
            <th scope="row" class="text-right">Custom Category:</th>
            <td>
                <input type="text" id="customCategory" style="width: 200px;" placeholder="Enter custom category" />
            </td>
        </tr>

        <!-- REFERENCE -->
        <tr>
            <th scope="row" class="text-right">Reference:</th>
            <td>
                <select id="referenceSelect" style="width: 200px;" onchange="toggleReferenceTextbox()" name="reference">
                    <option value="">Other (Please specify)</option>
                    {% for reference in references %}
                        <option value="{{ reference }}" {% if form.reference.value == reference %}selected{% endif %}>{{ reference }}</option>
                    {% endfor %}
                </select>
            </td>
        </tr>
        <tr id="customReferenceRow" style="display: none;">
            <th scope="row" class="text-right">Custom Reference:</th>
            <td>
                <input type="text" id="customReference" style="width: 200px;" placeholder="Enter custom reference" />
            </td>
        </tr>

        </tbody>
    </table>

    <div class="d-flex justify-content-end gap-2">
        <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i>
        </button>
        <a href="{% url 'purchases_logs' %}" class="btn btn-secondary"><i class="fas fa-times"></i></a>
    </div>
</form>
{% endblock %}

{% block includejs %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// ================= VENDOR POPUP =================
function openVendorPopup() {
    $.ajax({
        url: "{% url 'vendor_purchase_filter' %}",
        success: function(vendors) {

            let html = `
                <input type="text" id="vendorSearch" class="form-control mb-2" placeholder="Search vendor...">
                <table class="table table-bordered" id="vendorTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Address</th>
                            <th>Phone</th>
                            <th>GSTIN</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            vendors.forEach(v => {
                html += `
                    <tr class="vendorRow" style="cursor:pointer"
                        data-id="${v.id}"
                        data-name="${v.name}">
                        <td>${v.name}</td>
                        <td>${v.address || '-'}</td>
                        <td>${v.phone || '-'}</td>
                        <td>${v.gstin || '-'}</td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;

            Swal.fire({
                title: "Select Vendor",
                html: html,
                width: "1000px",
                showCancelButton: true,
                didOpen: () => {
                    // Filter table by search
                    $('#vendorSearch').on('keyup', function () {
                        let val = $(this).val().toLowerCase();
                        $('#vendorTable tbody tr').filter(function () {
                            $(this).toggle($(this).text().toLowerCase().indexOf(val) > -1);
                        });
                    });

                    // Click row to select
                    $('.vendorRow').on('click', function () {
                        let id = $(this).data('id');
                        let name = $(this).data('name');

                        // Set hidden input for form submission
                        $('#vendorHidden').val(id);

                        // Set display input
                        $('#vendorDisplay').val(name);

                        Swal.close();
                    });
                }
            });
        }
    });
}

// ================= CATEGORY & REFERENCE TOGGLE =================
function toggleCategoryTextbox() {
    var categorySelect = document.getElementById('categorySelect');
    var customCategoryRow = document.getElementById('customCategoryRow');
    var customCategoryInput = document.getElementById('customCategory');
    
    if (categorySelect.value === "") {
        customCategoryRow.style.display = 'table-row';
        customCategoryInput.required = true;
        customCategoryInput.setAttribute('name', 'category');
        categorySelect.removeAttribute('name');
    } else {
        customCategoryRow.style.display = 'none';
        customCategoryInput.value = '';
        customCategoryInput.required = false;
        categorySelect.setAttribute('name', 'category');
        customCategoryInput.removeAttribute('name');
    }
}

function toggleReferenceTextbox() {
    var referenceSelect = document.getElementById('referenceSelect');
    var customReferenceRow = document.getElementById('customReferenceRow');
    var customReferenceInput = document.getElementById('customReference');
    
    if (referenceSelect.value === "") {
        customReferenceRow.style.display = 'table-row';
        customReferenceInput.required = true;
        customReferenceInput.setAttribute('name', 'reference');
        referenceSelect.removeAttribute('name');
    } else {
        customReferenceRow.style.display = 'none';
        customReferenceInput.value = '';
        customReferenceInput.required = false;
        referenceSelect.setAttribute('name', 'reference');
        customReferenceInput.removeAttribute('name');
    }
}

// ================= EVENTS =================
$(document).ready(function () {
    $('#changeVendorBtn').on('click', openVendorPopup);

    // Autofill on edit
    let vendHidden = $('#vendorHidden');
    if (vendHidden.val()) {
        // Optionally, you could fetch vendor name via JS/Ajax or set server-side
        $('#vendorDisplay').val(vendHidden.data('name') || '');
    }

    // Trigger category/reference toggles on page load
    toggleCategoryTextbox();
    toggleReferenceTextbox();
});
</script>
{% endblock %}
