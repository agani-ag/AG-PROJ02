{% extends "base.html" %}

{% load static %}
{% load humanize %}
{% block content %}

	{% if messages %}
		{% for message in messages %}
			<div class="alert {% if message.tags == 'success' %} alert-success
				{% elif message.tags == 'error' %} alert-danger {% else %} alert-primary {% endif %}">
			<p>{{ message.tags }}</p>
		{% endfor %}
	</div>
	{% endif %}

	<div class="row">
		<div class="col">
			<h2>Add Purchase</h2>
		</div>
		<div class="col text-right">
		</div>
	</div>

	<table class="table table-bordered" id="invoice-table">
		<form method="post">
			{% csrf_token %}
			<tr>
				<th>Date</th>
				<th><input type="datetime-local" value="{{ purchase_log.date|date:"Y-m-d\TH:i" }}" name="date" ></th>
			</tr>
			<tr>
				<th>Type</th>
				<th>
					<label><input type="radio" name="ptype" value="0" {% if purchase_log.ptype == 0 %}checked{% endif %}> Purchase</label>
					<label><input type="radio" name="ptype" value="1" {% if purchase_log.ptype == 1 %}checked{% endif %}> Paid</label>
				</th>
			</tr>
			<tr id="purchase-category-row">
				<th>Category</th>
				<th>
					<input list="purchase_categories" id="purchase_category" name="purchase_category" value="{{ purchase_log.purchase_category }}">
					<datalist id="purchase_categories">
						{% for cat in purchase_categories %}
							<option value="{{ cat }}">
						{% endfor %}
					</datalist>
				</th>
				<!-- <th><input type="text" name="purchase_category" placeholder="Purchase Category"></th> -->
			</tr>
			{{category}}
			<tr id="paid-category-row" style="display:none;">
				<th>Category</th>
				<th>
					<input list="paid_categories" id="paid_category" name="paid_category" value="{{ purchase_log.paid_category }}">
					<datalist id="paid_categories">
						{% for cat in paid_categories %}
							<option value="{{ cat }}">
						{% endfor %}
					</datalist>
					<!-- <select name="paid_category">
						<option value="Cheque">Cheque</option>
						<option value="RTGS">RTGS</option>
						<option value="NEFT">NEFT</option>
					</select> -->
				</th>
				<!-- <th><input type="text" name="paid_category" placeholder="Paid Category"></th> -->
			</tr>
			<tr>
				<th>Amount</th>
				<th><input type="number" name="amount" value="{{ purchase_log.amount }}" required></th>
			</tr>
			<tr>
				<th>Reference</th>
				<th>
					<input type="text" name="paid_reference" id="paid_reference" value="{{ purchase_log.paid_reference }}">
					<input type="text" name="purchase_reference" id="purchase_reference" value="{{ purchase_log.purchase_reference }}">
				</th>
			</tr>
			<tr>
				<th>Status</th>
				<th>
					<label><input type="radio" name="status" value="0" {% if purchase_log.status == 0 %}checked{% endif %}> Open</label>
					<label><input type="radio" name="status" value="1" {% if purchase_log.status == 1 %}checked{% endif %}> Closed</label>
				</th>
			</tr>
			<tr>
				<th>Vendor</th>
				<th>
					<select name="vendor">
						<option value="">Select Vendor</option>
						{% for vendor in vendors %}
						<option 
							value="{{ vendor.id }}"
							data-address="{{ vendor.vendor_address }}"
							data-phone="{{ vendor.vendor_phone }}"
							data-email="{{ vendor.vendor_email }}"
							data-gst="{{ vendor.vendor_gst }}"
							{% if vendor.id == purchase_log.vendor.id %} selected {% endif %}
							>
								{{ vendor.vendor_name }}
							</option>
						{% endfor %}
					</select>
				</th>
			</tr>
			<tr class="text-right">
				<th colspan="2">
					<button type="submit" class="btn btn-primary btn-curve"><i class="fas fa-save"></i></button>
					<a href="{% url 'purchases' %}" class="btn btn-danger btn-curve"><i class="fas fa-cancel"></i></a>
				</th>
			</tr>
		</form>
	</table>

	<div id="vendorPopup" style="
		display:none;
		position:absolute;
		padding:10px;
		background:#fff;
		border:1px solid #ccc;
		box-shadow:0 2px 6px rgba(0,0,0,0.2);
		width:250px;
	"></div>

<script>
  function toggleCategoryRow() {
    const isPurchaseSelected = document.querySelector('input[name="ptype"]:checked').value === '1';
    if (isPurchaseSelected) {
      document.getElementById('paid-category-row').style.display = 'table-row';
      document.getElementById('purchase-category-row').style.display = 'none';
	  document.getElementById('paid_reference').style.display = 'table-cell';
	  document.getElementById('purchase_reference').style.display = 'none';
    } else {
      document.getElementById('paid-category-row').style.display = 'none';
      document.getElementById('purchase-category-row').style.display = 'table-row';
	  document.getElementById('paid_reference').style.display = 'none';
	  document.getElementById('purchase_reference').style.display = 'table-cell';
    }
  }

  window.onload = function() {
    const ptypeRadios = document.querySelectorAll('input[name="ptype"]');
    ptypeRadios.forEach(function(radio) {
      radio.addEventListener('change', toggleCategoryRow);
    });
    toggleCategoryRow();
  };

  const input = document.querySelector('input#purchase_category');

  // Show all options when input is focused
  input.addEventListener('focus', () => {
    input.setAttribute('placeholder', 'Purchase Category');
    input.value = '';
    input.dispatchEvent(new Event('input'));
  });
</script>

<script>
	function showVendorPopup() {
		const select = document.querySelector('select[name="vendor"]');
		const selectedOption = select.options[select.selectedIndex];
		const address = selectedOption.getAttribute('data-address') || 'N/A';
		const phone = selectedOption.getAttribute('data-phone') || 'N/A';
		const email = selectedOption.getAttribute('data-email') || 'N/A';
		const gst = selectedOption.getAttribute('data-gst') || 'N/A';

		const popup = document.getElementById('vendorPopup');
		popup.innerHTML = `
			<strong>Address:</strong> ${address}<br>
			<strong>Phone:</strong> ${phone}<br>
			<strong>Email:</strong> ${email}<br>
			<strong>GST:</strong> ${gst}
		`;

		if (select.value) {
			popup.style.display = 'block';
			const rect = select.getBoundingClientRect();
			popup.style.top = (rect.bottom + window.scrollY) + 'px';
			popup.style.left = (rect.left + window.scrollX) + 'px';
		} else {
			popup.style.display = 'none';
		}
	}

	document.querySelector('select[name="vendor"]').addEventListener('change', showVendorPopup);

	// Show popup initially if a vendor is already selected
	window.addEventListener('DOMContentLoaded', function() {
		setTimeout(function() {
			showVendorPopup();
		}, 1000);
	});
</script>
{% endblock %}
