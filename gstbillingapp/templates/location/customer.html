<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Customer Location</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
#map { height: 80vh; }
</style>
</head>

<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
  <span class="navbar-brand ms-3">üìç Customer Live Location</span>
</nav>

<div class="container mt-3">
  <div id="status" class="alert alert-info">Detecting location‚Ä¶</div>
  <div id="map" class="rounded shadow"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const API_PUSH = "/api/location/push/";
const ROOM = "customer-room";
const USER = "{{ request.GET.cid | default:'unknown' }}";

const map = L.map("map").setView([0,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
const marker = L.marker([0,0]).addTo(map);

function send(lat,lng,accuracy){
 fetch(API_PUSH,{
   method:"POST",
   headers:{
     "Content-Type":"application/json",
     "X-CSRFToken":"{{ csrf_token }}"
   },
   body:JSON.stringify({
     lat:lat,
     lng:lng,
     accuracy:accuracy,
     user_id:USER,
     room:ROOM
   })
 })
}

function gpsSuccess(pos){
 const lat = pos.coords.latitude;
 const lng = pos.coords.longitude;
 marker.setLatLng([lat,lng]);
 map.setView([lat,lng],16);
 document.getElementById("status").innerText="GPS: Exact";
 send(lat,lng,"gps");
}

function gpsError(){
 fetch("https://ipinfo.io/json")
 .then(r => r.json())
 .then(d => {
   if(!d.loc) return;

   const [lat, lng] = d.loc.split(",").map(Number);

   marker.setLatLng([lat, lng]);
   map.setView([lat, lng], 12);
   document.getElementById("status").innerText = "IP: Approximate";
   send(lat, lng, "approx");
 });
}

navigator.geolocation.watchPosition(
 gpsSuccess,
 gpsError,
 {enableHighAccuracy:true,timeout:5000}
);
</script>

</body>
</html>
