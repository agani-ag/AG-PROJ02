<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Employee Dashboard</title>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">

<style>
#map { height: 85vh; }
</style>
</head>

<body>

<nav class="navbar navbar-dark bg-dark">
  <span class="navbar-brand ms-3">ðŸ§­ Employee Dashboard</span>
</nav>

<div class="container-fluid mt-2">
  <div class="alert alert-secondary">Tracking Customers Live</div>
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
const API_PUSH = "/api/location/push/";
const API_POLL = "/api/location/poll/";
const ROOM = "employee-room";
const USER = "{{ request.GET.title | default:'unknown' }}";

const map = L.map("map").setView([0,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let heat = L.heatLayer([], {radius:25}).addTo(map);
let lastTs = null;

// ---------------- PUSH EMPLOYEE LOCATION ----------------
function send(lat,lng,accuracy){
 fetch(API_PUSH,{
   method:"POST",
   headers:{
     "Content-Type":"application/json",
     "X-CSRFToken":"{{ csrf_token }}"
   },
   body:JSON.stringify({
     lat:lat,
     lng:lng,
     accuracy:accuracy,
     user_id:USER,
     room:ROOM
   })
 })
}

function gpsSuccess(p){
 send(p.coords.latitude,p.coords.longitude,"gps");
}

function gpsError(){
 fetch("https://ipinfo.io/json")
 .then(r => r.json())
 .then(d => {
   if(!d.loc) return;
   const [lat, lng] = d.loc.split(",").map(Number);
   send(lat, lng, "approx");
 });
}

navigator.geolocation.watchPosition(gpsSuccess,gpsError,{enableHighAccuracy:true});

// ---------------- POLL CUSTOMER LOCATIONS ----------------
function poll(){
 let url = API_POLL + "?user_type=customer";
 if(lastTs) url += "&since=" + lastTs;

 fetch(url)
 .then(r=>r.json())
 .then(data=>{
   data.forEach(p=>{
     lastTs = p.time;
     heat.addLatLng([p.lat,p.lng,0.6]);
   });
 });
}

setInterval(poll,1000);
</script>

</body>
</html>
