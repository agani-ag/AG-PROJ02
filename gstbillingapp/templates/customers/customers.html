{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="row">
	<div class="col">
		<h2>Customers</h2>
	</div>
	<div class="col text-right" style="padding-top: 0.5%;">
		
		<a href="{% url 'customer_add' %}" class="btn btn-primary btn-sm btn-curve"><i class="fas fa-plus"></i></a>
		<a href="{% url 'feature_upload' %}" class="btn btn-success btn-sm btn-curve"><i class="fas fa-file-excel"></i></a>
		<button class="btn btn-warning btn-sm btn-curve" id="set-allcustomer-userid"><i class="fas fa-refresh"></i></button>
	</div>
</div>

<table class="table table-bordered" id="customer-table">
	<thead class="thead-dark">
		<tr>
			<th>Customer Name</th>
			<th>Address</th>
			<th>Phone</th>
			<th>GST NO</th>
			<th>Mobile</th>
			<th>Actions</th>
		</tr>
	</thead>
	<tbody class="two-col-form">
		{% for customer in customers %}
		<tr>
			<td>{{customer.customer_name}}</td>
			<td>{% if customer.customer_address %}{{customer.customer_address}}{% else %}<span class="text-muted">N/A</span>{% endif %}</td>
			<td>{% if customer.customer_phone %}{{customer.customer_phone}}{% else %}<span class="text-muted">N/A</span>{% endif %}</td>
			<td>{% if customer.customer_gst %}{{customer.customer_gst}}{% else %}<span class="text-muted">N/A</span>{% endif %}</td>
			<td>
				{% if customer.is_mobile_user %}
					<a href="#" class="btn btn-orange-on btn-sm btn-curve"><i class="fas fa-toggle-on"></i></a>
				{% else %}
					<a href="#" class="btn btn-orange-off btn-sm btn-curve"><i class="fas fa-toggle-off"></i></a>
				{% endif %}
			</td>
			<td>
				<div class="btn-group" role="group" aria-label="Basic example">
					<a href="{% url 'customer_edit' customer.id %}" class="btn btn-primary btn-sm btn-curve"><i class="fas fa-edit"></i></a>
					<button type="button" class="btn btn-danger btn-sm btn-curve" data-toggle="modal" data-target="#customerDeleteModal" data-customer-id="{{customer.id}}" data-customer-name="{{customer.customer_name}}"><i class="fas fa-trash"></i></button>
					<a href="{% url 'book_logs' customer.id %}" class="btn btn-warning btn-sm btn-curve"><i class="fas fa-file-alt"></i></a>
					{% if customer.customer_latitude and customer.customer_longitude %}
					<a href="#" class="btn btn-success btn-sm btn-curve" onclick="popup_Customer_maps('{{ customer.customer_latitude }}', '{{ customer.customer_longitude }}', '{{ customer.customer_name }}')">
						<i class="fas fa-map-marker-alt"></i></a>
					{% endif %}
				</div>
			</td>
		</tr>
		{% endfor %}
	</tbody>
</table>

<div class="modal fade" id="customerDeleteModal" tabindex="-1" role="dialog" aria-labelledby="customerDeleteModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="customerDeleteModalLabel">Are you sure?</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form method="POST" action="{% url 'customer_delete' %}">
			{% csrf_token %}
			<div class="modal-body">
				Are you sure you want to delete <b><span class="customer-name"></span></b>?
					<div class="form-group">
						<input hidden="true" type="text" class="form-control" name="customer_id">
					</div>
			</div>
			<div class="modal-footer">
				<button type="submit" class="btn btn-danger" >Yes</button>
				<button type="button" class="btn btn-primary" data-dismiss="modal">No</button>
			</div>
			</form>
		</div>
	</div>
</div>

{% endblock %}


{% block includejs %}
<script type="text/javascript">
$('#customerDeleteModal').on('show.bs.modal', function (event) {
	var button = $(event.relatedTarget) // Button that triggered the modal
	var customer_id = button.data('customer-id') // Extract info from data-* attributes
	var customer_name = button.data('customer-name') // Extract info from data-* attributes
	// If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
	// Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
	var modal = $(this)
	modal.find('.modal-body input').val(customer_id)
	console.log(customer_name)
	modal.find('.customer-name').html(customer_name)
});


$(document).ready( function () {
	$('#customer-table').DataTable({
		"order": [],
		"columnDefs": [{
				"targets": 4,
				"sortable": false,
				"searchable": false
			},
			{
				"targets": 5,
				"sortable": false,
				"searchable": false
			}],
		"paging": true,
		dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excelHtml5',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-success btn-sm btn-curve'
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: 'btn btn-danger btn-sm btn-curve'
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print"></i> Print',
                className: 'btn btn-warning btn-sm btn-curve'
            }
        ]
	});
});

$('#set-allcustomer-userid').click(function(){
	Swal.fire({
		title: 'All Customer User IDs',
		text: "This will set User IDs for all customers!",
		icon: 'warning',
		showCancelButton: true,
		confirmButtonColor: '#3085d6',
		cancelButtonColor: '#d33',
		confirmButtonText: 'Yes, set User IDs!'
	}).then((result) => {
		if (result.isConfirmed) {
			$.ajax({
				type: "POST",
				url: "/customers/api/all_userid_set",
				data: {
					'customer_userid': '{{ user.id }}',
				},
				success: function(response) {
					Swal.fire(
						'Success!',
						response.message,
						'success'
					).then(() => {
						location.reload();
					});
				},
				error: function(xhr, status, error) {
					Swal.fire(
						'Error!',
						'An error occurred while setting User IDs.',
						'error'
					);
				}
			});
		}
	});
});

function popup_Customer_maps(latitude, longitude, name) {

    Swal.fire({
        html: `<div id="map" style="height: 600px; width: 98%;"></div>`,
        width: '80%',
        showCloseButton: true,
        showConfirmButton: false,
        didOpen: () => {
            // Initialize map only after the popup DOM is created
            var map = L.map('map').setView([latitude, longitude], 17);

            var satelliteLayer = L.tileLayer(
                'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                { attribution: '© Esri © OpenStreetMap contributors' }
            ).addTo(map);

            var osmLayer = L.tileLayer(
                'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                { attribution: '© OpenStreetMap contributors' }
            );

            L.marker([latitude, longitude])
                .addTo(map)
                .bindTooltip(name, {
                    permanent: true,
                    offset: [0, -15],
                    direction: 'top'
                })
                .openPopup();

            setTimeout(() => {
                map.invalidateSize();
            }, 200);
        }
    });
}
</script>
{% endblock %}
