{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="row">
	<div class="col">
		<h2>Customers</h2>
	</div>
	<div class="col text-right" style="padding-top: 0.5%;">
		<a href="{% url 'customerall_userid_set' %}" class="btn btn-warning btn-sm btn-curve" style="text-decoration: none;">
			<i class="fas fa-refresh"></i>
		</a>
		<a href="#" class="btn btn-success btn-sm btn-curve" style="text-decoration: none;">
			<i class="fas fa-file-excel"></i>
		</a>
		<a href="{% url 'customer_add' %}">
			<button type="button" class="btn btn-primary btn-sm btn-curve">
				<i class="fas fa-plus"></i>
			</button>
		</a>
		<!-- ✅ Column Toggle Dropdown -->
		<div class="dropdown d-inline-block">
			<button class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="columnToggleDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				<i class="fas fa-columns"></i>
			</button>
			<div class="dropdown-menu" aria-labelledby="columnToggleDropdown" id="columnToggleMenu" style="padding:10px; min-width: 200px;">
				<!-- checkboxes will be dynamically created -->
			</div>
		</div>
	</div>
</div>
<!-- AG GRID CONTAINER -->
<div class="ag-theme-alpine mt-3" id="customerGrid" style="height: 600px; width: 100%;"></div>

<!-- DELETE MODAL -->
<div class="modal fade" id="customerDeleteModal" tabindex="-1" role="dialog" aria-labelledby="customerDeleteModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="customerDeleteModalLabel">Are you sure?</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form method="POST" action="{% url 'customer_delete' %}">
				{% csrf_token %}
				<div class="modal-body">
					Are you sure you want to delete <b><span class="customer-name"></span></b>?
					<div class="form-group">
						<input type="hidden" class="form-control" name="customer_id">
					</div>
				</div>
				<div class="modal-footer">
					<button type="submit" class="btn btn-danger">Yes</button>
					<button type="button" class="btn btn-primary" data-dismiss="modal">No</button>
				</div>
			</form>
		</div>
	</div>
</div>

{% endblock %}


{% block includejs %}

<script>
document.addEventListener('DOMContentLoaded', function() {

	const columnDefs = [
		{ headerName: "Customer Name", field: "customer_name", sortable: true, filter: true, flex: 2 },
		{ headerName: "Address", field: "customer_address", sortable: true, filter: true, flex: 2, hide: true,
			cellRenderer: params => params.value ? params.value : '<span style="color:red;">N/A</span>'
		},
		{ headerName: "Phone", field: "customer_phone", sortable: true, filter: true },
		{ headerName: "GST No", field: "customer_gst", sortable: true, filter: true,
			cellRenderer: params => params.value ? params.value : '<span style="color:red;">N/A</span>'
		},
		{ headerName: "Mobile User", field: "is_mobile_user", cellRenderer: params => {
			return `<span class="switch">
						<input type="checkbox" ${params.value ? "checked" : ""} disabled>
						<span class="slider round"></span>
					</span>`;
		}, width: 120 },
		{ headerName: "Edit", field: "edit", width: 100, cellRenderer: params => `
			<a href="/customers/edit/${params.data.id}">
				<button type="button" class="btn btn-dark btn-sm">Edit</button>
			</a>
		` },
		{ headerName: "Delete", field: "delete", width: 120, cellRenderer: params => `
			<button type="button" class="btn btn-danger btn-sm"
				data-toggle="modal"
				data-target="#customerDeleteModal"
				data-customer-id="${params.data.id}"
				data-customer-name="${params.data.customer_name}">
				Delete
			</button>
		` },
		{ headerName: "Logs", field: "logs", width: 100, cellRenderer: params => `
			<a href="/book/logs/${params.data.id}/">
				<button type="button" class="btn btn-warning btn-sm"><b>${params.data.id}</b></button>
			</a>
		` }
	];

	const rowData = [
		{% for customer in customers %}
		{
			id: {{customer.id}},
			customer_name: "{{customer.customer_name|escapejs}}",
			customer_address: "{{customer.customer_address|default_if_none:''|escapejs}}",
			customer_phone: "{{customer.customer_phone|default_if_none:''|escapejs}}",
			customer_gst: "{{customer.customer_gst|default_if_none:''|escapejs}}",
			is_mobile_user: {{ customer.is_mobile_user|yesno:"true,false" }},
		},
		{% endfor %}
	];

	const gridOptions = {
		columnDefs: columnDefs,
		rowData: rowData,
		pagination: true,
		paginationPageSize: 10,
		defaultColDef: { resizable: true, 
		}
	};

	const gridDiv = document.querySelector('#customerGrid');
	new agGrid.Grid(gridDiv, gridOptions);
	// ✅ Create toggle checkboxes dynamically
	const menu = document.getElementById('columnToggleMenu');
	columnDefs.forEach(col => {
		if (col.field) { // skip computed buttons
			const div = document.createElement('div');
			div.innerHTML = `
				<label style="display:block;">
					<input type="checkbox" class="column-toggle" data-col="${col.field}" ${col.hide ? '' : 'checked'}>
					${col.headerName}
				</label>
			`;
			menu.appendChild(div);
		}
	});

	// ✅ Listen for checkbox changes
	menu.addEventListener('change', function(e) {
		if (e.target.classList.contains('column-toggle')) {
			const colField = e.target.getAttribute('data-col');
			const visible = e.target.checked;
			gridOptions.api.setColumnVisible(colField, visible);
		}
	});
});


// ✅ DELETE MODAL DATA SETUP
$('#customerDeleteModal').on('show.bs.modal', function (event) {
	var button = $(event.relatedTarget);
	var customer_id = button.data('customer-id');
	var customer_name = button.data('customer-name');
	var modal = $(this);
	modal.find('input[name="customer_id"]').val(customer_id);
	modal.find('.customer-name').text(customer_name);
});
</script>
{% endblock %}
