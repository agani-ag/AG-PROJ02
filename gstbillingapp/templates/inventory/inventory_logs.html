{% extends "base.html" %}
{% load tz %}
{% load static %}
{% load humanize %}

{% block content %}
<h2>Inventory Details</h2>
<hr>

<div class="row">
	<div class="col">
		<h6>
			Model No: 
			{% if inventory.product.model_no %}
				<b>{{inventory.product.model_no}}</b>
			{% else %}
				<b class="text-danger">N/A</b>
			{% endif %}
		</h6>
		<h6>
			Product: 
			{% if inventory.product.product_name %}
				<b>{{inventory.product.product_name}}</b>
			{% else %}
				<b class="text-danger">N/A</b>
			{% endif %}
			</h6>
		<h6>
			HSN: 
			{% if inventory.product.product_hsn %}
				<b>{{inventory.product.product_hsn}}</b>
			{% else %}
				<b class="text-danger">N/A</b>
			{% endif %}
			</h6>
		<h6>
			<span style="cursor:pointer;" onclick="alert_levelupdate({{ inventory.id }}, {{ inventory.alert_level }})">
				Stock Alert Level : <span class="text-primary font-weight-bold">{{ inventory.alert_level }}</span>
			</span>
		</h6>
		<h4>
			Current Stock: 
			<b>{% if inventory.current_stock > 0 %}
				<span class="text-success">{{ inventory.current_stock }}</span>
			{% else %}
				<span class="text-danger">{{ inventory.current_stock }}</span>
			{% endif %}</b>
		</h4>
	</div>
	<div class="col text-right">
		<a href="{% url 'inventory_logs_add' inventory.id %}" class="btn btn-primary btn-sm btn-curve">
			<i class="fas fa-plus"></i></a>
		<a href="{% url 'inventory' %}" class="btn btn-danger btn-sm btn-curve"><i class="fas fa-reply"></i></a>
		<a href="{% url 'product_edit' inventory.product.id %}" class="btn btn-warning btn-sm btn-curve"><i class="fas fa-pen-to-square"></i></a>
	</div>
</div>

<hr>

<table class="table table-hover font-weight-bold" id="inventory-logs-table">
	<thead class="thead-dark">
		<tr>
			<th>Date</th>
			<th>Type</th>
			<th>Change</th>
			<th>Description</th>
			<th></th>
		</tr>
	</thead>
	<tbody class="two-col-form">
		{% for item in inventory_logs %}
		<tr class="{% if item.change < 0 %}table-danger{% else %}table-success{%endif%}">
			<td>{{item.date|localtime|date:"M d, Y h:i A"}}</td>
			<td>{{item.get_change_type_display}} {% if item.associated_invoice %}<a href="{% url 'invoice_viewer' item.associated_invoice.id %}">[INVOICE]</a>{% endif %}</td>
			<td>{{item.change}}</td>
			<td>{{item.description}}</td>
			<td>
				{% if not item.associated_invoice %}
					<a href="{% url 'inventory_logs_del' item.id %}" class="btn btn-danger btn-sm btn-curve">
						<i class="fas fa-trash"></i>
					</a>
				{% endif %}
			</td>
		{% endfor %}
	</tbody>
</table>



{% endblock %}


{% block includejs %}
<script type="text/javascript">
$(document).ready( function () {
	$('#inventory-logs-table').DataTable({
		"order": [],
		"paging": true,
		dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excelHtml5',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-success btn-sm btn-curve'
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: 'btn btn-danger btn-sm btn-curve'
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print"></i> Print',
                className: 'btn btn-warning btn-sm btn-curve'
            }
        ]
	});
});

function alert_levelupdate(inventoryId, currentLevel) {
    Swal.fire({
        title: "Update Stock Alert Level",
        input: "number",
        inputLabel: "Enter new alert level",
        inputValue: currentLevel,
        inputAttributes: {
            min: 1
        },
        showCancelButton: true,
        confirmButtonText: "Update",
        cancelButtonText: "Cancel",
        confirmButtonColor: "#3085d6",
        inputValidator: (value) => {
            if (!value || value <= 0) {
                return "Please enter a valid alert level!";
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            fetch("/inventory/api/stock-alert-level/add", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: `inventory_id=${inventoryId}&alert_level=${result.value}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    Swal.fire("Updated!", data.message, "success")
                    .then(() => {
                        location.reload(); // refresh to show updated value
                    });
                } else {
                    Swal.fire("Error", data.message, "error");
                }
            })
            .catch(() => {
                Swal.fire("Error", "Something went wrong!", "error");
            });
        }
    });
}
</script>
{% endblock %}