{% extends "base.html" %}
{% load tz %}
{% load static %}
{% load humanize %}

{% block content %}
<h2>Book Details</h2>
<hr>
<div class="row">
	<div class="col">
		<h3>Customer: <span class="text-primary">{{book.customer.customer_name}}</span></h3>
        <h3>Current Balance: {% if book.current_balance > 0 %}
            <span class="text-success">{{ book.current_balance|floatformat:2 }}</span>
            {% else %}<span class="text-danger">{{ book.current_balance|floatformat:2 }}</span>{% endif %}</h3>

	</div>
	<div class="col text-right">
		<a href="{% url 'book_logs_add' book.id %}" class="btn btn-primary btn-sm btn-curve">
			<i class="fas fa-plus"></i></a>
		<a href="{% url 'books' %}" class="btn btn-danger btn-sm btn-curve"><i class="fas fa-reply"></i></a>
		<a href="{% url 'customer_edit' book.customer.id %}" class="btn btn-warning btn-sm btn-curve"><i class="fas fa-edit"></i></a>
	</div>
</div>
<hr>
<table class="table table-hover font-weight-bold" id="inventory-logs-table">
	<thead class="thead-dark">
		<tr>
			<th>Date</th>
			<th>Type</th>
			<th>Change</th>
			<th>Description</th>
			<th></th>
		</tr>
	</thead>
	<tbody class="two-col-form">
		{% for item in book_logs %}
		<tr class="{% if item.change < 0 %}table-danger{% else %}table-success{%endif%}">
			<td>{{item.date|localtime|date:"M d, Y h:i A"}}</td>
			<td>{{item.get_change_type_display}}</td>
			<td>{{item.change}}</td>
			<td>{{item.description}}</td>
			<td>
				{% if item.associated_invoice %}
                    <a href="{% url 'invoice_viewer' item.associated_invoice.id %}" class="btn btn-primary btn-sm btn-curve">
                        <i class="fas fa-file-invoice"></i>
                    </a>
				{% else %}
					<a href="{% url 'book_logs_del' item.id %}" class="btn btn-danger btn-sm btn-curve">
						<i class="fas fa-trash"></i>
					</a>
				{% endif %}
			</td>
		{% endfor %}
	</tbody>
</table>



{% endblock %}


{% block includejs %}
<script type="text/javascript">
$(document).ready( function () {
	$('#inventory-logs-table').DataTable({
		"order": [],
        "columnDefs": [ {
            "targets": 4,
            "sortable": false,
            "searchable": false
        } ],
		"paging": true,
		dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excelHtml5',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-success btn-sm btn-curve'
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: 'btn btn-danger btn-sm btn-curve'
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print"></i> Print',
                className: 'btn btn-warning btn-sm btn-curve',
				title: '', // Leave empty to avoid default title
                customize: function (win) {

                    // Add custom header HTML
                    $(win.document.body).prepend(`
                        <div id="customHeader" style="text-align:center; margin-bottom:20px;">
                            <h2 style="margin:0;">Inventory Logs Report</h2>
                            <h4 style="margin:0;">{{book.customer.customer_name}}</h3>
                            <h4 style="margin:0;">Current Balance: {{ book.current_balance }}</h3>
                            <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                            <hr style="border:1px solid #000;">
                        </div>
                    `);

                    // Add print-specific CSS for repeating header
                    const css = `
                        <style>
                            @media print {
                                #customHeader {
                                    position: running(header);
                                }
                                body {
                                    counter-reset: page;
                                }
                                @page {
                                    @top-center {
                                        content: element(header);
                                    }
                                    margin-top: 100px;
                                }
                            }
                        </style>
                    `;

                    $(win.document.head).append(css);

                    // Style table
                    $(win.document.body).find('table')
                        .addClass('compact')
                        .css('font-size', 'inherit')
                        .css('width', '100%');
                }
            }
        ]
	});
});
</script>
{% endblock %}