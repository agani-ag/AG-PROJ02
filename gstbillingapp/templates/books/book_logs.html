{% extends "base.html" %}
{% load tz %}
{% load static %}
{% load humanize %}

{% block content %}
<h2>Book Details</h2>
<hr>
<div class="row">
	<div class="col">
		<h3>Customer: <span class="text-primary">{{book.customer.customer_name}}</span></h3>
        <h3>Current Balance: {% if book.current_balance > 0 %}
            <span class="text-success">{{ book.current_balance|floatformat:2 }}</span>
            {% else %}<span class="text-danger">{{ book.current_balance|floatformat:2 }}</span>{% endif %}</h3>

	</div>
	<div class="col text-right">
		<a href="{% url 'book_logs_add' book.id %}" class="btn btn-primary btn-sm btn-curve">
			<i class="fas fa-plus"></i></a>
		<a href="{% url 'books' %}" class="btn btn-danger btn-sm btn-curve"><i class="fas fa-reply"></i></a>
		<a href="{% url 'customer_edit' book.customer.id %}" class="btn btn-warning btn-sm btn-curve"><i class="fas fa-pen-to-square"></i></a>
	</div>
</div>
<hr>
<!-- Summary Cards Row -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-receipt"></i> Total Sales</h6>
                <h3>₹ {{ total_purchased | default:0 | floatformat:2 | intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-circle-check"></i> Total Paid</h6>
                <h3>₹ {{ total_paid | default:0 | floatformat:2 | intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-orange text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-reply"></i> Total Returned</h6>
                <h3>₹ {{ total_returned | default:0 | floatformat:2 | intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-violet text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-recycle"></i> Total Others</h6>
                <h3>₹ {{ total_others | default:0 | floatformat:2 | intcomma }}</h3>
            </div>
        </div>
    </div>
</div>
<table class="table table-hover font-weight-bold" id="inventory-logs-table">
	<thead class="thead-dark">
		<tr>
			<th>Date</th>
			<th>Type</th>
			<th>Change</th>
			<th>Description</th>
			<th></th>
		</tr>
	</thead>
	<tbody class="two-col-form">
		{% for item in book_logs %}
		<!-- <tr class="{% if item.change < 0 %}table-danger{% else %}table-success{%endif%}"> -->
            {% if item.is_active and item.change_type == 0 %}
                <tr class="table-success">
            {% elif item.is_active and item.change_type == 1 %}
                <tr class="table-danger">
            {% elif item.is_active and item.change_type == 2 %}
                <tr class="table-warning">
            {% elif item.is_active and item.change_type == 3 %}
                <tr class="table-primary">
            {% elif item.is_active and item.change_type == 4 %}
                <tr class="table-info">
            {% else %}
                <tr class="table-secondary">
            {% endif %}

			<td>{{item.date|localtime|date:"M d, Y h:i A"}}</td>
			<td>{{item.get_change_type_display}}</td>
			<td>{{item.change}}</td>
			<td>{{item.description}}</td>
            <td class="text-center">
                <div class="btn-group" role="group" aria-label="Basic example">
                    {% if item.associated_invoice %}
                        <a href="{% url 'invoice_viewer' item.associated_invoice.id %}" class="btn btn-primary btn-sm btn-curve">
                            <i class="fas fa-file-invoice"></i>
                        </a> 
                    {% endif %}
                    {% if item.change_type != 1 and item.change_type != 2 %}
                        <a href="{% url 'book_logs_del' item.id %}" class="btn btn-danger btn-sm btn-curve">
                            <i class="fas fa-trash"></i>
                        </a>
                    {% endif %}
                    {% if not item.associated_invoice and item.change_type == 1 %}
                        <a href="{% url 'book_logs_del' item.id %}" class="btn btn-danger btn-sm btn-curve">
                            <i class="fas fa-trash"></i>
                        </a>
                    {% endif %}
                    {% if not item.is_active %}
                        <span class="btn btn-warning btn-sm btn-curve" onclick="markAsActive({{ item.id }},{{ item.change }})"><i class="fas fa-arrow-up"></i></span>
                    {% endif %}
                    {% if item.change_type == 4 %}
                        <button onclick="handleBookLogChange({{ item.id }}, '{{ item.change }}')" class="btn btn-info btn-sm btn-curve"><i class="fas fa-arrow-up"></i></button>
                    {% endif %}
                </div>
            </td>
		{% endfor %}
	</tbody>
</table>



{% endblock %}


{% block includejs %}
<script type="text/javascript">
$(document).ready( function () {
	$('#inventory-logs-table').DataTable({
		"order": [],
        "columnDefs": [ {
            "targets": 4,
            "sortable": false,
            "searchable": false
        } ],
		"paging": true,
		dom: 'Bfrtip',
        buttons: [
            {
                extend: 'excelHtml5',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-success btn-sm btn-curve'
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: 'btn btn-danger btn-sm btn-curve'
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print"></i> Print',
                className: 'btn btn-warning btn-sm btn-curve',
				title: '', // Leave empty to avoid default title
                customize: function (win) {

                    // Add custom header HTML
                    $(win.document.body).prepend(`
                        <div id="customHeader" style="text-align:center; margin-bottom:20px;">
                            <h2 style="margin:0;">Inventory Logs Report</h2>
                            <h4 style="margin:0;">{{book.customer.customer_name}}</h3>
                            <h4 style="margin:0;">Current Balance: {{ book.current_balance }}</h3>
                            <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                            <hr style="border:1px solid #000;">
                        </div>
                    `);

                    // Add print-specific CSS for repeating header
                    const css = `
                        <style>
                            @media print {
                                #customHeader {
                                    position: running(header);
                                }
                                body {
                                    counter-reset: page;
                                }
                                @page {
                                    @top-center {
                                        content: element(header);
                                    }
                                    margin-top: 100px;
                                }
                            }
                        </style>
                    `;

                    $(win.document.head).append(css);

                    // Style table
                    $(win.document.body).find('table')
                        .addClass('compact')
                        .css('font-size', 'inherit')
                        .css('width', '100%');
                }
            }
        ]
	});
});

// Example SweetAlert usage for marking as active
function markAsActive(booklogId, change) {
    Swal.fire({
        title: 'Mark as Active?',
        text: "This will mark the book log as active. Updates "+ change,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, Update it!'
    }).then((result) => {
        if (result.isConfirmed) {
            // Make AJAX call to mark as active
            $.ajax({
                url: '/books/api/active',
                method: 'GET',
                data: { booklog: booklogId, change: change },
                success: function(response) {
                    Swal.fire(
                        'Marked!',
                        response.message,
                        'success'
                    ).then(() => {
                        location.reload();
                    });
                },
                error: function() {
                    Swal.fire(
                        'Error!',
                        'There was an error marking the book log as active.',
                        'error'
                    );
                }
            });
        }
    });
}
</script>

<script>
    // Function to handle book log change request
    function handleBookLogChange(booklog_id, booklog_change) {
        // Show SweetAlert modal with radio buttons
        Swal.fire({
            title: 'Select Status',
            html: `
                <div>
                    <label><input type="radio" name="status" value="0" onclick="toggleInputs(false)"> Success</label>
                    <br>
                    <label><input type="radio" name="status" value="4" onclick="toggleInputs(true)"> Failed</label>
                </div>
                <div id="failedInputs" style="display:none;">
                    <div><span class="font-weight-bold">Amount :${booklog_change}</span></div>
                    <div>
                        <label for="change">Change:</label>
                        <input type="number" id="change" name="change" placeholder="Enter change" min="0" required>
                    </div>
                    <div>
                        <label for="description">Description:</label>
                        <input type="text" id="description" name="description" placeholder="Enter description" required>
                    </div>
                </div>
            `,
            showCancelButton: true,
            confirmButtonText: 'Submit',
            cancelButtonText: 'Cancel',
            preConfirm: () => {
                // Get selected status
                const status = document.querySelector('input[name="status"]:checked');
                if (!status) {
                    Swal.showValidationMessage('Please select a status');
                    return false;
                }

                const statusValue = status.value;
                let change = "";
                let description = "";

                // If "Failed" is selected, get change and description values
                if (statusValue === "4") {
                    change = document.getElementById("change").value;
                    description = document.getElementById("description").value;
                    if (!change || !description) {
                        Swal.showValidationMessage('Please fill in the change and description fields');
                        return false;
                    }
                }

                // Return the data to be sent to the backend
                return {
                    booklog_id: booklog_id,
                    booklog_change: change,
                    booklog_description: description,
                    booklog_options: statusValue
                };
            }
        }).then((result) => {
            if (result.isConfirmed) {
                // Send the POST request to the server with the result
                const { booklog_id, booklog_change, booklog_description, booklog_options } = result.value;
                
                // Send data to backend
                fetch("{% url 'book_logs_pending' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                    body: new URLSearchParams({
                        'booklog_id': booklog_id,
                        'booklog_change': booklog_change,
                        'booklog_description': booklog_description,
                        'booklog_options': booklog_options
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        Swal.fire('Success!', data.message, 'success');
                    } else {
                        Swal.fire('Error!', data.message, 'error');
                    }
                })
                .catch(error => {
                    Swal.fire('Oops!', 'Something went wrong. Please try again.', 'error');
                });
            }
        });
    }

    // Function to show/hide input fields for "Failed" status
    function toggleInputs(isFailed) {
        const failedInputs = document.getElementById("failedInputs");
        if (isFailed) {
            failedInputs.style.display = "block";
        } else {
            failedInputs.style.display = "none";
        }
    }
</script>

{% endblock %}