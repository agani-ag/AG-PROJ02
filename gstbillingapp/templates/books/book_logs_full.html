{% extends "base.html" %}
{% load tz %}
{% load humanize %}
{% load static %}

{% block content %}
<h2>All Book Details</h2>
<hr>

<!-- Summary Cards Row -->
<div class="row mb-3">
    <div class="col-md-3">
        <div class="card bg-danger text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-receipt"></i> Total Sales</h6>
                <h3>₹ {{ total_purchased | default:0 | floatformat:2 | intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-circle-check"></i> Total Paid</h6>
                <h3>₹ {{ total_paid | default:0 | floatformat:2 | intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-orange text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-reply"></i> Total Returned</h6>
                <h3>₹ {{ total_returned | default:0 | floatformat:2 | intcomma }}</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-violet text-white">
            <div class="card-body">
                <h6 class="card-title"><i class="fas fa-recycle"></i> Total Others</h6>
                <h3>₹ {{ total_others | default:0 | floatformat:2 | intcomma }}</h3>
            </div>
        </div>
    </div>
</div>

<!-- Action Buttons Row -->
<div class="row mb-3 align-items-end">
    <div class="col-md-3">
        <strong>Total Balance :
            {% if total_balance > 0 %}
                <span class="text-danger">₹ {{ total_balance | default:0 | floatformat:2 | intcomma }}</span>
            {% else %}
                <span class="text-success">₹ {{ total_balance | default:0 | floatformat:2 | intcomma }}</span>
            {% endif %}
        </strong><br>
        <span class="font-weight-bold" id="balanceWord">{{ total_balance_word }}</span>
    </div>
    <div class="col-md-9">
        <div class="row align-items-end">
            <div class="col-md-2">
                <label for="changeTypeFilter" class="mb-1"><small><strong>Type:</strong></small></label>
                <select id="changeTypeFilter" class="form-control form-control-sm">
                    <option value="all">All Types</option>
                    <option value="0">Paid</option>
                    <option value="1">Sales</option>
                    <option value="2">Returned</option>
                    <option value="3">Others</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="dateFilter" class="mb-1"><small><strong>Date:</strong></small></label>
                <select id="dateFilter" class="form-control form-control-sm">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="col-md-3" id="startDateWrapper" style="display:none;">
                <label for="startDate" class="mb-1"><small><strong>From:</strong></small></label>
                <input type="date" id="startDate" class="form-control form-control-sm">
            </div>
            <div class="col-md-3" id="endDateWrapper" style="display:none;">
                <label for="endDate" class="mb-1"><small><strong>To:</strong></small></label>
                <input type="date" id="endDate" class="form-control form-control-sm">
            </div>
            <div class="col-md-2">
                <button id="clearFilters" class="btn btn-secondary btn-sm btn-block">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
            <div class="col-md-1 text-right">
                <a href="{% url 'book_logs_full_add' %}" class="btn btn-primary btn-sm btn-curve btn-block">
                    <i class="fas fa-plus"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<hr>

<!-- Book Logs Table -->
<table class="table table-hover font-weight-bold" id="inventory-logs-table">
    <thead class="thead-dark align-middle">
        <tr>
            <th>Date</th>
            <th>Type</th>
            <th class="text-center">Change</th>
            <th>Description</th>
            <th>Customer</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        <!-- Data loaded via AJAX -->
    </tbody>
</table>

<style>
#inventory-logs-table tbody tr td {
    vertical-align: middle;
}

.customer-name {
    min-width: 150px; /* minimum width */
    max-width: 250px; /* maximum width */
    white-space: normal; /* allow text to wrap */
    word-wrap: break-word; /* break long words if needed */
}
</style>

{% endblock %}

{% block includejs %}
<script type="text/javascript">
$(document).ready(function() {
    var table = $('#inventory-logs-table').DataTable({
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": "{% url 'book_logs_full_ajax' %}",
            "type": "GET",
            "data": function(d) {
                d.change_type = $('#changeTypeFilter').val() || 'all';
                d.date_filter = $('#dateFilter').val() || 'all';
                d.start_date = $('#startDate').val() || '';
                d.end_date = $('#endDate').val() || '';
                console.log('Sending data:', d);
            },
            "error": function(xhr, error, code) {
                console.error('AJAX Error Details:', {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    error: error,
                    code: code
                });
                var errorMsg = 'Error loading data: ';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg += xhr.responseJSON.error;
                } else if (xhr.responseText) {
                    errorMsg += xhr.responseText;
                } else {
                    errorMsg += xhr.status + ' ' + xhr.statusText;
                }
                alert(errorMsg + '\n\nCheck browser console for more details.');
            },
            "dataSrc": function(json) {
                console.log('Received data:', json);
                if (json.error) {
                    alert('Server error: ' + json.error);
                    return [];
                }
                // Update summary cards if totals are provided
                if (json.totals) {
                    updateSummaryCards(json.totals);
                }
                return json.data;
            }
        },
        "columns": [
            { "data": "date", "orderable": true },
            { "data": "type", "orderable": true },
            { "data": "change", "orderable": true, "className": "text-center font-weight-bold" },
            { "data": "description", "orderable": true, "visible": false },
            { "data": "customer", "orderable": true, "className": "customer-name" },
            { "data": "actions", "orderable": false, "className": "text-center" }
        ],
        "order": [[0, "desc"]],
        "pageLength": 15,
        "lengthMenu": [[10, 15, 25, 50, 100, 200], [10, 15, 25, 50, 100, 200]],
        "searching": true,
        "info": true,
        "createdRow": function(row, data, dataIndex) {
            if (data.DT_RowClass) {
                $(row).addClass(data.DT_RowClass);
            }
        },
        dom: 'Blfrtip',
        buttons: [
            {
                extend: 'excelHtml5',
                text: '<i class="fas fa-file-excel"></i> Excel',
                className: 'btn btn-success btn-sm btn-curve',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4]
                }
            },
            {
                extend: 'pdfHtml5',
                text: '<i class="fas fa-file-pdf"></i> PDF',
                className: 'btn btn-danger btn-sm btn-curve',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4]
                }
            },
            {
                extend: 'print',
                text: '<i class="fas fa-print"></i> Print',
                className: 'btn btn-warning btn-sm btn-curve',
                title: '',
                exportOptions: {
                    columns: [0, 1, 2, 3, 4]
                },
                customize: function(win) {
                    $(win.document.body).prepend(`
                        <div id="customHeader" style="text-align:center; margin-bottom:20px;">
                            <h2 style="margin:0;">All Book Logs Report</h2>
                            <table style="width:50%; margin:0 auto; border-collapse: collapse;" border="1">
                            <tr><td>Total Purchased</td><td>₹ {{ total_purchased | default:0 | floatformat:2 | intcomma  }}</td></tr>
                            <tr><td>Total Paid</td><td>₹ {{ total_paid | default:0 | floatformat:2 | intcomma  }}</td></tr>
                            <tr><td>Total Returned</td><td>₹ {{ total_returned | default:0 | floatformat:2 | intcomma  }}</td></tr>
                            <tr><td>Total Others</td><td>₹ {{ total_others | default:0 | floatformat:2 | intcomma  }}</td></tr>
                            <tr><td>Total Balance</td><td>₹ {{ total_balance | default:0 | floatformat:2 | intcomma  }}</td></tr>
                            </table>
                            <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
                            <hr style="border:1px solid #000;">
                        </div>
                    `);

                    const css = `
                        <style>
                            @media print {
                                body { counter-reset: page; }
                                table { font-size: inherit; width: 100%; }
                            }
                        </style>
                    `;
                    $(win.document.head).append(css);
                }
            },
            {
                text: 'Description',
                className: 'btn btn-info btn-sm btn-curve',
                action: function(e, dt, node, config) {
                    let col = dt.column(3);
                    col.visible(!col.visible());
                }
            }
        ]
    });

    // Show/hide custom date range inputs
    $('#dateFilter').on('change', function() {
        if ($(this).val() === 'custom') {
            $('#startDateWrapper').show();
            $('#endDateWrapper').show();
        } else {
            $('#startDateWrapper').hide();
            $('#endDateWrapper').hide();
            table.ajax.reload();
        }
    });

    // Auto-reload when custom date inputs change
    $('#startDate, #endDate').on('change', function() {
        if ($('#dateFilter').val() === 'custom' && $('#startDate').val() && $('#endDate').val()) {
            table.ajax.reload();
        }
    });

    // Clear filters button
    $('#clearFilters').on('click', function() {
        $('#changeTypeFilter').val('all');
        $('#dateFilter').val('all');
        $('#startDate').val('');
        $('#endDate').val('');
        $('#startDateWrapper').hide();
        $('#endDateWrapper').hide();
        table.ajax.reload();
    });

    // Auto-reload on change for type filter
    $('#changeTypeFilter').on('change', function() {
        table.ajax.reload();
    });
    
    // Function to update summary cards
    function updateSummaryCards(totals) {
        // Format numbers with commas
        const formatNumber = (num) => {
            return new Intl.NumberFormat('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        };
        
        // Update card values
        $('.card.bg-danger h3').text('₹ ' + formatNumber(totals.total_purchased));
        $('.card.bg-success h3').text('₹ ' + formatNumber(totals.total_paid));
        $('.card.bg-orange h3').text('₹ ' + formatNumber(totals.total_returned));
        $('.card.bg-violet h3').text('₹ ' + formatNumber(totals.total_others));
        
        // Update total balance
        const balanceSpan = totals.total_balance > 0 ? 
            '<span class="text-danger">₹ ' + formatNumber(totals.total_balance) + '</span>' :
            '<span class="text-success">₹ ' + formatNumber(totals.total_balance) + '</span>';
        
        $('.col-md-3 strong').html('Total Balance : ' + balanceSpan);
        $('#balanceWord').text(totals.total_balance_word);
    }
});

// Example SweetAlert usage for marking as active
function markAsActive(booklogId, change) {
    Swal.fire({
        title: 'Mark as Active?',
        text: "This will mark the book log as active. Updates "+ change,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, Update it!'
    }).then((result) => {
        if (result.isConfirmed) {
            $.ajax({
                url: '/books/api/active',
                method: 'GET',
                data: { booklog: booklogId, change: change },
                success: function(response) {
                    Swal.fire(
                        'Marked!',
                        response.message,
                        'success'
                    ).then(() => {
                        location.reload();
                    });
                },
                error: function() {
                    Swal.fire(
                        'Error!',
                        'There was an error marking the book log as active.',
                        'error'
                    );
                }
            });
        }
    });
}
</script>
{% endblock %}
