{% extends "base.html" %}
{% load static %}

{% block content %}

	{% if non_gst_mode %}	
		<h2> Non-GST Invoices</h2>
	{% else %}
		<h2>Invoices</h2>
	{% endif %}

		<table class="table table-bordered" id="invoice-table">
		<thead class="thead-dark">
			<tr>
				<!-- <th>Incoice ID</th> -->
				<th>Invoice Number</th>
				<th>Date</th>
				<th>Customer</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody class="two-col-form">
			{% for invoice in invoices %}
			<tr>
 				<!-- <td>{{invoice.id}}</td> -->
 				<td>
					{% if invoice.non_gst_mode %}
						<span class="text-danger font-weight-bold">NG{{invoice.invoice_number}}</span>
					{% else %}
						{{invoice.invoice_number}}
					{% endif %}
				</td>
 				<td>{{invoice.invoice_date}}</td>
 				<td>
					{% if invoice.invoice_customer %}
						<a href="{% url 'book_logs' invoice.invoice_customer.id %}" style="text-decoration: none;color: black;">
							{{invoice.invoice_customer}}</a>
					{% else %}
						<span class="text-danger">N/A</span>
					{% endif %}
				</td>
				<td>
					<div class="btn-group" role="group" aria-label="Basic example">
						<button type="button" onclick="popup_invoice({{ invoice.id }})" class="btn btn-primary btn-sm btn-curve"><i class="fa fa-eye"></i></button>
						<a href="{% url 'invoice_viewer' invoice.id %}" class="btn btn-warning btn-sm btn-curve"><i class="fa fa-external-link-square"></i></a>
						{% if invoice.invoice_customer %}
							<a href="{% url 'customer_edit' invoice.invoice_customer.id %}" class="btn btn-orange btn-sm btn-curve"><i class="fa fa-user"></i></a>
						{% endif %}
						<button type="button" class="btn btn-danger btn-sm btn-curve" data-toggle="modal" data-target="#invoiceDeleteModal" data-invoice-id="{{invoice.id}}" data-invoice-number="{{invoice.invoice_number}}, for {{invoice.invoice_customer}}"><i class="fa fa-trash"></i></button>
					</div>
				</td>
			</tr>
			{% endfor %}
		</tbody>
		</table>

		<div class="modal fade" id="invoiceDeleteModal" tabindex="-1" role="dialog" aria-labelledby="invoiceDeleteModalLabel" aria-hidden="true">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" id="invoiceDeleteModalLabel">Are you sure?</h5>
						<button type="button" class="close" data-dismiss="modal" aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<form method="POST" action="{% url 'invoice_delete' %}">
					{% csrf_token %}
					<div class="modal-body">
						Are you sure you want to delete <b><span class="invoice-number"></span></b>?
							<div class="form-group">
								<input hidden="true" type="text" class="form-control" name="invoice_id">
								<input type="checkbox" id="book-del" name="book-del" value="book-del" checked> <b>Remove Book Deductions Also</b><br>
								<input type="checkbox" id="inventory-del" name="inventory-del" value="inventory-del" checked> <b>Remove Inventory Deductions Also</b>
							</div>
					</div>
					<div class="modal-footer">
						<button type="submit" class="btn btn-danger btn-sm btn-curve" >Yes</button>
						<button type="button" class="btn btn-primary btn-sm btn-curve" data-dismiss="modal">No</button>
					</div>
					</form>
				</div>
			</div>
		</div>
{% endblock %}


{% block includejs %}
<script type="text/javascript">

	$('#invoiceDeleteModal').on('show.bs.modal', function (event) {
		var button = $(event.relatedTarget) // Button that triggered the modal
		var invoice_id = button.data('invoice-id') // Extract info from data-* attributes
		var invoice_number = button.data('invoice-number') // Extract info from data-* attributes
		// If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
		// Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
		var modal = $(this)
		modal.find('.modal-body input').val(invoice_id)
		console.log(invoice_number)
		modal.find('.invoice-number').html(invoice_number)
	});


	$(document).ready( function () {
		$('#invoice-table').DataTable({
			"order": [],
			"columnDefs": [ {
				"targets": 3,
				"sortable": false,
				"searchable": false
			} ],
			"paging": true
		});
	});

	function popup_invoice(invoice) {
		fetch("/invoice/"+invoice+"?nav=1")
		.then(r => r.text())
		.then(html => {
		Swal.fire({
			html: `<div style="height:80vh; overflow-y:auto;width:90%;margin:auto;border:2px solid #ccc;">${html}</div>`,
			width: '80%',
			showCloseButton: true,
			showConfirmButton: false,
		});
	});
}	
</script>
{% endblock %}
