{% extends "base.html" %}
{% load static %}

{% block content %}

	<h2>Invoices</h2>

	<!-- Filter Options Row -->
	<div class="row mb-3 align-items-end">
		<div class="col-md-2">
			<label for="invoiceTypeFilter" class="mb-1"><small><strong>Type:</strong></small></label>
			<select id="invoiceTypeFilter" class="form-control form-control-sm">
				<option value="all">All Types</option>
				<option value="gst" selected>GST</option>
				<option value="non_gst">Non-GST</option>
				<option value="not_pushed">Not Pushed to Books</option>
				<option value="missing_in_books">Missing in Books</option>
			</select>
		</div>
		<div class="col-md-2">
			<label for="customerFilter" class="mb-1"><small><strong>Customer:</strong></small></label>
			<select id="customerFilter" class="form-control form-control-sm">
				<option value="">All Customers</option>
				{% for customer in customers %}
				<option value="{{ customer.id }}">{{ customer.customer_name }}</option>
				{% endfor %}
			</select>
		</div>
		<div class="col-md-2">
			<label for="dateFilter" class="mb-1"><small><strong>Date:</strong></small></label>
			<select id="dateFilter" class="form-control form-control-sm">
				<option value="all">All Time</option>
				<option value="today">Today</option>
				<option value="week">This Week</option>
				<option value="month">This Month</option>
				<option value="custom">Custom</option>
			</select>
		</div>
		<div class="col-md-2" id="startDateWrapper" style="display:none;">
			<label for="startDate" class="mb-1"><small><strong>From:</strong></small></label>
			<input type="date" id="startDate" class="form-control form-control-sm">
		</div>
		<div class="col-md-2" id="endDateWrapper" style="display:none;">
			<label for="endDate" class="mb-1"><small><strong>To:</strong></small></label>
			<input type="date" id="endDate" class="form-control form-control-sm">
		</div>
		<div class="col-md-1">
			<button id="clearFilters" class="btn btn-secondary btn-sm btn-block">
				<i class="fas fa-times"></i> Clear
			</button>
		</div>
		<div class="col-md-3">
			<div class="card shadow-sm border-danger">
				<div class="card-body p-2 text-center">
					<small class="text-muted d-block" style="font-size: 0.75rem;">TOTAL AMOUNT</small>
					<div id="total-invoice-amount" class="font-weight-bold text-danger" style="font-size: 1.3rem;">
						<i class="fas fa-spinner fa-spin"></i>
					</div>
				</div>
			</div>
		</div>
	</div>

<hr>

	<table class="table table-bordered" id="invoice-table">
		<thead class="thead-dark">
			<tr>
				<th>Invoice Number</th>
				<th>Date</th>
				<th>Customer</th>
				<th>Invoice Amount</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody>
			<!-- Data loaded via AJAX -->
		</tbody>
	</table>

<div class="modal fade" id="invoiceDeleteModal" tabindex="-1" role="dialog" aria-labelledby="invoiceDeleteModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="invoiceDeleteModalLabel">Are you sure?</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form method="POST" action="{% url 'invoice_delete' %}">
			{% csrf_token %}
			<div class="modal-body">
				Are you sure you want to delete <b><span class="invoice-number"></span></b>?
					<div class="form-group">
						<input hidden="true" type="text" class="form-control" name="invoice_id">
						<input type="checkbox" id="book-del" name="book-del" value="book-del" checked> <b>Remove Book Deductions Also</b><br>
						<input type="checkbox" id="inventory-del" name="inventory-del" value="inventory-del" checked> <b>Remove Inventory Deductions Also</b>
					</div>
			</div>
			<div class="modal-footer">
				<button type="submit" class="btn btn-danger btn-sm btn-curve" >Yes</button>
				<button type="button" class="btn btn-primary btn-sm btn-curve" data-dismiss="modal">No</button>
			</div>
			</form>
		</div>
	</div>
</div>
{% endblock %}


{% block includejs %}
<script type="text/javascript">

	$('#invoiceDeleteModal').on('show.bs.modal', function (event) {
		var button = $(event.relatedTarget) // Button that triggered the modal
		var invoice_id = button.data('invoice-id') // Extract info from data-* attributes
		var invoice_number = button.data('invoice-number') // Extract info from data-* attributes
		// If necessary, you could initiate an AJAX request here (and then do the updating in a callback).
		// Update the modal's content. We'll use jQuery here, but you could use a data binding library or other methods instead.
		var modal = $(this)
		modal.find('.modal-body input').val(invoice_id)
		console.log(invoice_number)
		modal.find('.invoice-number').html(invoice_number)
	});


	$(document).ready( function () {
		// Set default filter based on page mode
		$('#invoiceTypeFilter').val('gst');

		var table = $('#invoice-table').DataTable({
			"processing": true,
			"serverSide": true,
			"ajax": {
				"url": "/invoices/ajax",
				"type": "GET",
				"data": function(d) {
					d.invoice_type = $('#invoiceTypeFilter').val() || 'all';
					d.customer_id = $('#customerFilter').val() || '';
					d.date_filter = $('#dateFilter').val() || 'all';
					d.start_date = $('#startDate').val() || '';
					d.end_date = $('#endDate').val() || '';
					console.log('Sending request data:', d);
				},
				"error": function(xhr, error, code) {
					console.error('AJAX Error:', {
						status: xhr.status,
						statusText: xhr.statusText,
						responseText: xhr.responseText,
						error: error,
						code: code
					});
					alert('Error loading data. Check console for details.');
				},
				"dataSrc": function(json) {
					console.log('Received data:', json);
					if (json.error) {
						alert('Server error: ' + json.error);
						return [];
					}
					return json.data;
				}
			},
			"columns": [
				{ "data": "invoice_number", "orderable": true },
				{ "data": "invoice_date", "orderable": true },
				{ "data": "customer", "orderable": true },
				{ "data": "invoice_amount", "orderable": false },
				{ "data": "actions", "orderable": false }
			],
			"order": [[1, "desc"]],
			"pageLength": 15,
			"lengthMenu": [[10, 15, 25, 50, 100], [10, 15, 25, 50, 100]],
			"searching": true,
			"info": true
		});

	// Show total invoice amount
	table.on('xhr', function(e, settings, json) {
		if (json && typeof json.total_invoice_amount !== 'undefined') {
			$('#total-invoice-amount').html('<strong>â‚¹ ' + json.total_invoice_amount.toLocaleString('en-IN', {minimumFractionDigits:2, maximumFractionDigits:2}) + '</strong>');
		}
	});
		// Show/hide custom date range inputs
		$('#dateFilter').on('change', function() {
			if ($(this).val() === 'custom') {
				$('#startDateWrapper').show();
				$('#endDateWrapper').show();
			} else {
				$('#startDateWrapper').hide();
				$('#endDateWrapper').hide();
				table.ajax.reload();
			}
		});

		// Auto-reload when custom date inputs change
		$('#startDate, #endDate').on('change', function() {
			if ($('#dateFilter').val() === 'custom' && $('#startDate').val() && $('#endDate').val()) {
				table.ajax.reload();
			}
		});

		// Clear filters button
		$('#clearFilters').on('click', function() {
			$('#invoiceTypeFilter').val('all');
			$('#customerFilter').val('');
			$('#dateFilter').val('all');
			$('#startDate').val('');
			$('#endDate').val('');
			$('#startDateWrapper').hide();
			$('#endDateWrapper').hide();
			table.ajax.reload();
		});

		// Auto-reload on change for invoice type filter
		$('#invoiceTypeFilter').on('change', function() {
			table.ajax.reload();
		});

		// Auto-reload on change for customer filter
		$('#customerFilter').on('change', function() {
			table.ajax.reload();
		});
	});

	function popup_invoice(invoice) {
		fetch("/invoice/"+invoice+"?nav=1")
		.then(r => r.text())
		.then(html => {
		Swal.fire({
			html: `<div style="height:80vh; overflow-y:auto;width:90%;margin:auto;border:2px solid #ccc;">${html}</div>`,
			width: '80%',
			showCloseButton: true,
			showConfirmButton: false,
		});
	});
}

function pushToBooks(invoiceId) {
	Swal.fire({
		title: 'Push to Books?',
		text: "This will manually add this invoice to the books.",
		icon: 'question',
		showCancelButton: true,
		confirmButtonColor: '#28a745',
		cancelButtonColor: '#6c757d',
		confirmButtonText: 'Yes, Push it!'
	}).then((result) => {
		if (result.isConfirmed) {
			// Show loading
			Swal.fire({
				title: 'Processing...',
				text: 'Pushing invoice to books',
				allowOutsideClick: false,
				allowEscapeKey: false,
				didOpen: () => {
					Swal.showLoading();
				}
			});

			// Make AJAX request
			fetch(`/invoices/push-to-books/${invoiceId}`, {
				method: 'POST',
				headers: {
					'X-CSRFToken': '{{ csrf_token }}',
					'Content-Type': 'application/json'
				}
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					Swal.fire({
						icon: 'success',
						title: 'Success!',
						text: data.message,
						timer: 2000
					}).then(() => {
						// Reload the table to update the button visibility
						$('#invoice-table').DataTable().ajax.reload();
					});
				} else {
					Swal.fire({
						icon: 'error',
						title: 'Error',
						text: data.message
					});
				}
			})
			.catch(error => {
				Swal.fire({
					icon: 'error',
					title: 'Error',
					text: 'An error occurred while pushing to books'
				});
				console.error('Error:', error);
			});
		}
	});
}	

</script>
{% endblock %}
