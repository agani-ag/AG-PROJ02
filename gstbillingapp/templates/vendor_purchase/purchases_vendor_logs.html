{% extends "base.html" %}
{% load tz %}
{% load static %}
{% load humanize %}
{% block title %}Vendor Purchases Logs{% endblock %}
{% block includecss %}
<style>
	/* Fix Tingle z-index over Bootstrap & DataTables */
	.tingle-modal {
		z-index: 20000 !important;
	}
	.tingle-modal-box {
		z-index: 20001 !important;
	}
	/* Soft blur overlay */
	.tingle-modal.tingle-blur .tingle-modal-overlay {
		background: rgba(255,255,255,0);       /* fully transparent overlay */
		backdrop-filter: blur(2px);            /* softer blur */
		-webkit-backdrop-filter: blur(2px);    /* Safari support */
		transition: backdrop-filter 0.3s ease;
	}
	.tingle-modal.tingle-blur.tingle-open .tingle-modal-overlay {
		backdrop-filter: blur(2px) brightness(1.05);
		-webkit-backdrop-filter: blur(2px) brightness(1.05);
	}
	.custom-tingle .tingle-modal-box {
	max-width: 420px;
	}
	.custom-tingle input,
	.custom-tingle select {
		width: 100%;
		padding: 8px;
		margin-bottom: 10px;
		box-sizing: border-box;
	}
	.custom-tingle label {
		font-weight: 600;
		margin-top: 8px;
		display: block;
	}
	.custom-tingle button[type="submit"] {
		width: 100%;
		padding: 10px;
		background: #2563eb;
		color: white;
		border: none;
		border-radius: 4px;
	}
</style>
{% endblock %}
{% block content %}
	<h2>Vendor Details</h2>
	<hr>
	<div>
		<div class="row">
			<div class="col-md-6">
				<h4>Vendor: <span class="text-primary">{{vendor.vendor_name}}</span></h4>
				<p class="font-weight-bold">
					<span>Current Balance:</span> 
					<span class="text-danger">
						<a href="?filter=balance" class="text-danger">
						₹ {{ total_balance | default:0 | floatformat:2 | intcomma }} </a></span>
					<span>({{ total_balance_word }})</span>
				</p>
			</div>
			<div class="col-md-6 text-right" style="display: flex; align-items: center; justify-content: flex-end;gap: 5px;">
				<button id="openPurchaseModal" class="btn btn-primary btn-sm btn-curve" title="Add New Purchase"><i class="fas fa-plus"></i></button>
				<a href="{% url 'purchases_logs_overdue' %}" class="btn btn-warning btn-sm btn-curve" title="View Overdue Purchases">
					<i class="fas fa-exclamation-triangle"></i></a>
				<a href="{% url 'feature_upload' %}" class="btn btn-success btn-sm btn-curve" title="Upload Purchases">
					<i class="fas fa-file-excel"></i>
				</a>
			</div>
		</div>
		
		<!-- Summary Cards Row -->
		<div class="row mb-3">
			<div class="col-md-3">
				<div class="card bg-danger text-white">
					<div class="card-body">
						<h6 class="card-title"><i class="fas fa-receipt"></i> Total Sales</h6>
						<h3>₹ {{ total_purchased | default:0 | floatformat:2 | intcomma }}</h3>
						<a href="?filter=purchased" class="stretched-link"></a>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card bg-success text-white">
					<div class="card-body">
						<h6 class="card-title"><i class="fas fa-circle-check"></i> Total Paid</h6>
						<h3>₹ {{ total_paid | default:0 | floatformat:2 | intcomma }}</h3>
						<a href="?filter=paid" class="stretched-link"></a>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card bg-orange text-white">
					<div class="card-body">
						<h6 class="card-title"><i class="fas fa-reply"></i> Total Returned</h6>
						<h3>₹ {{ total_returned | default:0 | floatformat:2 | intcomma }}</h3>
						<a href="?filter=returned" class="stretched-link"></a>
					</div>
				</div>
			</div>
			<div class="col-md-3">
				<div class="card bg-violet text-white">
					<div class="card-body">
						<h6 class="card-title"><i class="fas fa-recycle"></i> Total Others</h6>
						<h3>₹ {{ total_others | default:0 | floatformat:2 | intcomma }}</h3>
						<a href="?filter=others" class="stretched-link"></a>
					</div>
				</div>
			</div>
		</div>

	<table class="table table-hover font-weight-bold" id="purchase-table">
		<thead class="thead-dark">
			<tr>
				<th>Date</th>
				<th>Type</th>
				<th>Amount</th>
				<th>Reference</th>
				<th>Vendor</th>
				<th>Actions</th>
			</tr>
		</thead>
		<tbody class="two-col-form">
			{% for purchase in purchases %}
				{% if purchase.change_type == 0 %}
					<tr class="table-success">
				{% elif purchase.change_type == 1 %}
					<tr class="table-danger">
				{% elif purchase.change_type == 2 %}
					<tr class="table-warning">
				{% else %}
					<tr class="table-info">
				{% endif %}

				<td>
					{{ purchase.date|localtime|date:"M d, Y h:i A" }}
					<br>
					<small class="text-muted">{{ purchase.date|naturaltime }}</small>
				</td>
				<td>{{purchase.get_change_type_display }}</td>
				<td>{% if purchase.change %}₹ {{purchase.change}}{% else %}<span class="text-muted">N/A</span>{% endif %}</td>
				<td>
					{% if purchase.reference %}
						{{purchase.reference}}
					{% else %}
						<span class="text-danger">N/A</span>
					{% endif %}
					{% if purchase.change != 0 %}
						<br><span class="text-muted">{{ purchase.category }}</span>
					{% endif %}
				</td>
				<td>
					{% if purchase.vendor %}
						{{ purchase.vendor.vendor_name }}
					{% else %}
						<span class="text-danger">N/A</span>
					{% endif %}
				</td>
				<td>
					<div class="btn-group" role="group" aria-label="Basic example">
						<a href="{% url 'purchases_logs_delete' purchase.id %}?vendor={{ vendor.id }}" class="btn btn-danger btn-sm btn-curve" title="Delete Purchase"><i class="fas fa-trash"></i></a>
					</div>
				</td>
			</tr>
			{% endfor %}
		</tbody>
	</table>
{% endblock %}

{% block includejs %}
<script type="text/template" id="purchaseFormTemplate">
  <form id="purchaseForm">
    {% csrf_token %}

    <label>Date</label>
    <input type="date" name="date" id="dateInput" required>

    <label>Change Type</label>
    <select name="change_type">
      <option value="0">Paid</option>
      <option value="1">Purchase</option>
      <option value="2">Return</option>
      <option value="3">Other</option>
    </select>

    <label>Amount</label>
    <input type="number" name="change" required>

    <input type="hidden" name="vendor" value="{{ vendor.id }}">

    <label>Reference</label>
    <input type="text" name="reference1" placeholder="Enter reference">
    <select name="reference2">
	  <option value="">-- Select Reference --</option>
	  {% for ref in references %}
		<option value="{{ ref }}">{{ ref }}</option>
	  {% endfor %}
	</select>

    <label>Category</label>
    <input type="text" name="category1" placeholder="Enter category">
	<select name="category2">
	  <option value="">-- Select Category --</option>
	  {% for category in categories %}
		<option value="{{ category }}">{{ category }}</option>
	  {% endfor %}
	</select>

    <button type="submit" style="margin-top:10px;">Save</button>

    <div id="formErrors" style="color:red;margin-top:10px;"></div>
  </form>
</script>
<script type="text/javascript">
	$(document).ready( function () {
		$('#purchase-table').DataTable({
			"order": [],
			"columnDefs": [ {
				"targets": 5,
				"sortable": false,
				"searchable": false
			} ],
			"paging": true
		});
	});

/* Today */
const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
document.getElementById('dateInput').value = today;
/* Create modal */
const modal = new tingle.modal({
  footer: false,
  stickyFooter: false,
  closeMethods: ['overlay', 'button', 'escape'],
  closeLabel: "Close",
  cssClass: ['custom-tingle', 'tingle-blur'],
});

/* Open modal */
document.getElementById("openPurchaseModal").addEventListener("click", () => {
  modal.setContent(
    document.getElementById("purchaseFormTemplate").innerHTML
  );
  modal.open();

  attachFormHandler();
});

/* Attach form submit AFTER modal opens */
function attachFormHandler() {
  const form = document.getElementById("purchaseForm");
  const errorsDiv = document.getElementById("formErrors");

  form.onsubmit = function (e) {
    e.preventDefault();
    errorsDiv.innerHTML = "";

    const formData = new FormData(form);

    fetch("{% url 'purchases_logs_add_api' %}", {
      method: "POST",
      headers: {
        "X-Requested-With": "XMLHttpRequest",
        "X-CSRFToken": form.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        modal.close();
  		location.reload(); // simplest & reliable
      } else {
        for (const field in data.errors) {
          const p = document.createElement("p");
          p.innerText = `${field}: ${data.errors[field].join(", ")}`;
          errorsDiv.appendChild(p);
        }
      }
    })
    .catch(err => {
      console.error(err);
      errorsDiv.innerText = "Something went wrong.";
    });
  };
}
</script>
{% endblock %}
