{% extends "base.html" %}

{% load static %}

{% block content %}

<h2>Edit Quotation #{{quotation_number}}</h2>

<form method="POST" id="invoice-form">

	<table class="table table-bordered">
		<thead>
			<tr>
				<th class="table-active" scope="col" colspan="4">Quotation Details</th>
			</tr>
		</thead>

		<tbody class="two-col-form">
			<tr>
				<th scope="row">Quotation Number</th>
				<td class="form-input-td"><input name="invoice-number" type="number" class="form-control" placeholder="Quotation Number" min="1" value="{{quotation_number}}" readonly></td>
				<th scope="row">Date</th>
				<td class="form-input-td"><input name="invoice-date" type="date" class="form-control" min="1" value="{{quotation_date}}"></td>
			</tr>
			<tr>
				<th scope="row">Valid Until</th>
				<td class="form-input-td" colspan="3"><input name="valid-until" type="date" class="form-control" min="1" value="{{valid_until}}"></td>
			</tr>
		</tbody>
	</table>

	<table class="table table-bordered">
		<thead>
			<tr>
				<th class="table-active" scope="col" colspan="3">Customer Details</th>
				<th class="table-active" scope="col" colspan="1">
					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="modify-customer-details" name="modify-customer-details" {% if quotation.customer_details_modified %}checked{% endif %}>
						<label class="form-check-label" for="modify-customer-details">
							<strong>Modify Details</strong>
						</label>
					</div>
				</th>
			</tr>
		</thead>

		<tbody class="two-col-form">
			<tr>
				<th scope="row">Customer Name</th>
				<td class="form-input-td customer_search_area"><input autocomplete="off" name="customer-name" type="text" class="form-control customer_search_input" id="customer-name-input" placeholder="Customer Name" value="{{quotation_data.customer_name}}" required {% if quotation.customer_details_modified %}style="background-color: #fff3cd;"{% endif %}>
				</td>
				<th scope="row">Customer Address</th>
				<td class="form-input-td"><input autocomplete="off" name="customer-address" type="text" class="form-control" id="customer-address-input" placeholder="Customer Address" value="{{quotation_data.customer_address}}" required {% if not quotation.customer_details_modified %}readonly{% endif %} {% if quotation.customer_details_modified %}style="background-color: #fff3cd;"{% endif %}></td>
			</tr>
			<tr>
				<th scope="row">Customer Mobile Number</th>
				<td class="form-input-td"><input autocomplete="off" name="customer-phone" type="tel" class="form-control" id="customer-phone-input" placeholder="Customer Mobile Number" value="{{quotation_data.customer_phone}}" {% if not quotation.customer_details_modified %}readonly{% endif %} {% if quotation.customer_details_modified %}style="background-color: #fff3cd;"{% endif %}></td>
				<th scope="row">Customer GST</th>
				<td class="form-input-td"><input autocomplete="off" name="customer-gst" type="text" class="form-control" id="customer-gst-input" placeholder="Customer GST" maxlength="15" pattern="([A-Za-z0-9]{15})|(^$)" value="{{quotation_data.customer_gst}}" {% if not quotation.customer_details_modified %}readonly{% endif %} {% if quotation.customer_details_modified %}style="background-color: #fff3cd;"{% endif %}></td>
			</tr>

		</tbody>
	</table>

	<table class="table table-bordered">
		<tbody class="two-col-form">
			<tr>
				<th scope="row">Vehicle Number</th>
				<td class="form-input-td"><input autocomplete="off" name="vehicle-number" type="text" class="form-control" placeholder="Vehicle Number" value="{{quotation_data.vehicle_number}}">
				</td>
				<th scope="row"></th>
				<td class="form-input-td">
					<div class="form-check">
						<input class="form-check-input" name="igstcheck" type="checkbox" id="igstcheck" {% if quotation_data.igstcheck %}checked{% endif %}>
						<label class="form-check-label" for="igstcheck">
							IGST
						</label>
					</div>
					<div class="form-check">
						<input class="form-check-input" name="nongstcheck" type="checkbox" id="nongstcheck" {% if quotation_data.nongstcheck %}checked{% endif %}>
						<label class="form-check-label" for="nongstcheck">
							Non-GST
						</label>
					</div>
				</td>
			</tr>
		</tbody>
	</table>

	<table class="table table-bordered" id="invoice-form-items-table">
		<thead>
			<th class="table-active" scope="col" colspan="14">Items</th>

			<tr>
				<th scope="col">Sl No.</th>
				<th scope="col">Model No</th>
				<th scope="col">Product</th>
				<th scope="col">HSN</th>

				<th scope="col">Discount %</th>
				
				<th scope="col">Qty</th>
				<th scope="col">MRP</th>
				<th scope="col">GST %</th>
				<th scope="col">Rate with Discount %</th>


				<th scope="col">Amt with Discount %</th>
				<th scope="col">SGST</th>
				<th scope="col">CGST</th>
				<th scope="col">IGST</th>
				<th scope="col">Amt with GST %</th>

			</tr>
		</thead>
		<tbody id="invoice-form-items-table-body">
			{% for item in quotation_data.items %}
			<tr>
				<td class="invoice-item-slno">{{forloop.counter}}</td>
				<td class="formSS-input-td"><input name="invoice-model-no" type="text" class="form-control product_search_area product_search_input" placeholder="Model No" value="{{item.invoice_model_no}}"></td>
				<td class="form-input-td"><input name="invoice-product" type="text" class="form-control" placeholder="Product" value="{{item.invoice_product}}" readonly></td>
				<td class="form-input-td"><input name="invoice-hsn" type="text" class="form-control" placeholder="HSN" value="{{item.invoice_hsn}}" readonly></td>
				

				<td class="form-input-td"><input name="invoice-discount" type="number" step="any" class="form-control" value='{{item.invoice_discount}}' placeholder="Discount" min="0"></td>

				<td class="form-input-td"><input name="invoice-qty" type="number" step="any" class="form-control" placeholder="Qty" value='{{item.invoice_qty}}' min="1"></td>
				<td class="form-input-td"><input name="invoice-rate-with-gst" type="number" step="any" class="form-control" placeholder="MRP" value='{{item.invoice_rate_with_gst}}' min="1"></td>
				<td class="form-input-td"><input name="invoice-gst-percentage" type="number" step="any" class="form-control" placeholder="GST %" value='{{item.invoice_gst_percentage}}' min="1"></td>


				<td class="form-input-td"><input name="invoice-rate-without-gst" type="number" step="any" class="form-control" placeholder="Rate without GST" value='{{item.invoice_rate_without_gst}}' readonly></td>
				<td class="form-input-td"><input name="invoice-amt-without-gst" type="number" step="any" class="form-control" value='{{item.invoice_amt_without_gst}}' readonly></td>
				<td class="form-input-td"><input name="invoice-amt-sgst" type="number" step="any" class="form-control" value='{{item.invoice_amt_sgst}}' readonly></td>
				<td class="form-input-td"><input name="invoice-amt-cgst" type="number" step="any" class="form-control" value='{{item.invoice_amt_cgst}}' readonly></td>
				<td class="form-input-td"><input name="invoice-amt-igst" type="number" step="any" class="form-control" value='{{item.invoice_amt_igst}}' readonly></td>
				<td class="form-input-td"><input name="invoice-amt-with-gst" type="number" step="any" class="form-control" value='{{item.invoice_amt_with_gst}}' readonly></td>
			</tr>
			{% endfor %}
		</tbody>

		<tr>
			<td colspan="9" class="text-right"><strong>TOTAL:</strong></td>
			<td class="form-input-td"><input name="invoice-total-amt-without-gst" type="number" step="any" class="form-control" value="{{quotation_data.invoice_total_amt_without_gst}}" readonly></td>
			<td class="form-input-td"><input name="invoice-total-amt-sgst" type="number" step="any" class="form-control" value="{{quotation_data.invoice_total_amt_sgst}}" readonly></td>
			<td class="form-input-td"><input name="invoice-total-amt-cgst" type="number" step="any" class="form-control" value="{{quotation_data.invoice_total_amt_cgst}}" readonly></td>
			<td class="form-input-td"><input name="invoice-total-amt-igst" type="number" step="any" class="form-control" value="{{quotation_data.invoice_total_amt_igst}}" readonly></td>
			<td class="form-input-td"><input name="invoice-total-amt-with-gst" type="number" step="any" class="form-control" value="{{quotation_data.invoice_total_amt_with_gst}}" readonly></td>
		</tr>

	</table>
	{% csrf_token %}
	<div class="d-flex justify-content-between">
		<div>
			<button class="btn btn-primary btn-sm" id="invoice-form-addrow" title="Add Rows"><i class="fas fa-plus"></i></button>
		</div>
		<div>
			<button type="submit" class="btn btn-primary btn-sm" id="invoice-save" title="Update Quotation"><i class="fas fa-check"></i></button>
			<a href="{% url 'quotation_viewer' quotation_id %}" class="btn btn-secondary btn-sm" title="View Quotation"><i class="fas fa-eye"></i></a>
			<a href="#" class="btn btn-danger btn-sm" onclick="cancel_quotation()" title="Cancel"><i class="fas fa-cancel"></i></a>
		</div>
	</div>

</form>
</div>

<div id="customer_search_bar"></div>
<div id="product_search_bar"></div>

{% endblock %}

{% block includejs %}
<script src="{% static "gstbillingapp/js/fuse-3.4.6.min.js" %}"></script>
<script src="{% static "gstbillingapp/js/main.js" %}"></script>

<script>
	function cancel_quotation() {
		Swal.fire({
			title: 'Are you sure?',
			text: "All unsaved changes will be lost!",
			icon: 'warning',
			showCancelButton: true,
			confirmButtonColor: '#3085d6',
			cancelButtonColor: '#d33',
			confirmButtonText: 'Yes, cancel it!'
		}).then((result) => {
			if (result.isConfirmed) {
				window.location.href = "{% url 'quotation_viewer' quotation_id %}";
			}
		});
	}

// Handle Modify Customer Details checkbox
const modifyCheckbox = document.getElementById("modify-customer-details");
const customerNameInput = document.getElementById("customer-name-input");
const customerAddressInput = document.getElementById("customer-address-input");
const customerPhoneInput = document.getElementById("customer-phone-input");
const customerGstInput = document.getElementById("customer-gst-input");

// Store original customer data
const originalCustomerData = {
	name: "{{quotation.quotation_customer.customer_name}}",
	address: "{{quotation.quotation_customer.customer_address}}",
	phone: "{{quotation.quotation_customer.customer_phone}}",
	gst: "{{quotation.quotation_customer.customer_gst}}"
};

// Initialize state on load
if (modifyCheckbox.checked) {
	customerNameInput.classList.remove('customer_search_input');
}

// Track newly selected customer data during edit
let newlySelectedCustomerData = null;

// Listen for customer selection (when user selects a different customer)
const originalOnCustomerSelect = window.onCustomerSelect;
window.onCustomerSelect = function(customer) {
	if (originalOnCustomerSelect) {
		originalOnCustomerSelect(customer);
	}
	// Store newly selected customer data
	newlySelectedCustomerData = {
		name: customerNameInput.value,
		address: customerAddressInput.value,
		phone: customerPhoneInput.value,
		gst: customerGstInput.value
	};
	// Auto-uncheck modify mode when selecting a different customer
	if (modifyCheckbox.checked) {
		modifyCheckbox.checked = false;
		// Remove visual feedback
		customerNameInput.style.backgroundColor = '';
		customerAddressInput.style.backgroundColor = '';
		customerPhoneInput.style.backgroundColor = '';
		customerGstInput.style.backgroundColor = '';
	}
};

modifyCheckbox.addEventListener("change", function() {
	const isModifyEnabled = this.checked;
	
	if (isModifyEnabled) {
		// Enable editing of all customer fields
		customerNameInput.removeAttribute('readonly');
		customerAddressInput.removeAttribute('readonly');
		customerPhoneInput.removeAttribute('readonly');
		customerGstInput.removeAttribute('readonly');
		
		// Remove customer search functionality when modifying
		customerNameInput.classList.remove('customer_search_input');
		
		// Visual feedback
		customerNameInput.style.backgroundColor = '#fff3cd';
		customerAddressInput.style.backgroundColor = '#fff3cd';
		customerPhoneInput.style.backgroundColor = '#fff3cd';
		customerGstInput.style.backgroundColor = '#fff3cd';
		
		// Show info message
		Swal.fire({
			title: 'Modify Mode Enabled',
			text: 'You can now edit customer details. These changes will only apply to this quotation.',
			icon: 'info',
			timer: 3000
		});
	} else {
		// Restore readonly state for mapped customer
		customerAddressInput.setAttribute('readonly', 'readonly');
		customerPhoneInput.setAttribute('readonly', 'readonly');
		customerGstInput.setAttribute('readonly', 'readonly');
		
		// Re-enable customer search (user can change to different customer)
		customerNameInput.classList.add('customer_search_input');
		
		// Remove visual feedback
		customerNameInput.style.backgroundColor = '';
		customerAddressInput.style.backgroundColor = '';
		customerPhoneInput.style.backgroundColor = '';
		customerGstInput.style.backgroundColor = '';
		
		// Restore to newly selected customer if changed, otherwise original
		if (newlySelectedCustomerData) {
			customerNameInput.value = newlySelectedCustomerData.name;
			customerAddressInput.value = newlySelectedCustomerData.address;
			customerPhoneInput.value = newlySelectedCustomerData.phone;
			customerGstInput.value = newlySelectedCustomerData.gst;
			
			Swal.fire({
				title: 'Customer Changed',
				text: 'Customer details have been updated to the newly selected customer.',
				icon: 'success',
				timer: 2000
			});
		} else {
			// Restore original customer data
			customerNameInput.value = originalCustomerData.name;
			customerAddressInput.value = originalCustomerData.address;
			customerPhoneInput.value = originalCustomerData.phone;
			customerGstInput.value = originalCustomerData.gst;
			
			Swal.fire({
				title: 'Restored Original Customer',
				text: 'Customer details have been restored to the mapped customer record.',
				icon: 'success',
				timer: 2000
			});
		}
	}
});

$("#invoice-save").one("click", function () {
	$(this).fadeOut();
});
</script>
{% endblock %}
