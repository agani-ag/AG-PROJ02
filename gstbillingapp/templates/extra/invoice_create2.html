{% extends "gstbillingapp/base.html" %}
{% load static %}

{% block content %}
<h2>Create Invoice</h2>

<!-- Load Button -->
<button type="button" class="btn btn-success mb-3" id="load-data-btn">Load Invoice Data</button>

<!-- Invoice Form -->
<form method="POST" id="invoice-form" hidden>
    {% csrf_token %}

    <!-- Customer Details -->
    <table class="table table-bordered">
        <tr><th colspan="4" class="table-active">Customer Details</th></tr>
        <tr>
            <th>Customer Name</th>
            <td><input name="customer-name" class="form-control" required></td>
            <th>Customer Address</th>
            <td><input name="customer-address" class="form-control" required></td>
        </tr>
        <tr>
            <th>Mobile</th>
            <td><input name="customer-phone" class="form-control"></td>
            <th>GST</th>
            <td><input name="customer-gst" class="form-control" maxlength="15"></td>
        </tr>
    </table>

    <!-- IGST Checkbox -->
    <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="igstcheck">
        <label class="form-check-label" for="igstcheck">IGST</label>
    </div>

    <!-- Items Table -->
    <table class="table table-bordered" id="items-table">
        <thead>
            <tr>
                <th>Sl No</th>
                <th>Model</th>
                <th>Product</th>
                <th>HSN</th>
                <th>Discount %</th>
                <th>Qty</th>
                <th>MRP</th>
                <th>GST %</th>
                <th>Rate (No GST)</th>
                <th>Amt (No GST)</th>
                <th>SGST</th>
                <th>CGST</th>
                <th>IGST</th>
                <th>Total (With GST)</th>
            </tr>
        </thead>
        <tbody id="items-body"></tbody>
        <tfoot>
            <tr>
                <td colspan="9" class="text-end"><strong>Total:</strong></td>
                <td><input name="invoice-total-amt-without-gst" class="form-control" readonly></td>
                <td><input name="invoice-total-amt-sgst" class="form-control" readonly></td>
                <td><input name="invoice-total-amt-cgst" class="form-control" readonly></td>
                <td><input name="invoice-total-amt-igst" class="form-control" readonly></td>
                <td><input name="invoice-total-amt-with-gst" class="form-control" readonly></td>
            </tr>
        </tfoot>
    </table>

    <button type="submit" class="btn btn-primary">Submit Invoice</button>
</form>
{% endblock %}

{% block includejs %}
<script>
// Sample JSON Data
const customerData = {
    name: "John Doe",
    address: "123 Market Street",
    phone: "9876543210",
    gst: "29ABCDE1234F2Z5"
};

const itemsData = [
    { model: "MX1001", product: "LED Bulb 9W", hsn: "9405", discount: 10, qty: 5, mrp: 100, gstPercent: 18 },
    { model: "MX1002", product: "LED Tube 18W", hsn: "9405", discount: 5, qty: 2, mrp: 300, gstPercent: 18 }
];

document.getElementById("load-data-btn").addEventListener("click", () => {
    document.getElementById("invoice-form").hidden = false;

    // Fill customer
    document.querySelector("input[name='customer-name']").value = customerData.name;
    document.querySelector("input[name='customer-address']").value = customerData.address;
    document.querySelector("input[name='customer-phone']").value = customerData.phone;
    document.querySelector("input[name='customer-gst']").value = customerData.gst;

    const tbody = document.getElementById("items-body");
    tbody.innerHTML = "";

    itemsData.forEach((item, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${i + 1}</td>
            <td><input class="form-control model" value="${item.model}"></td>
            <td><input class="form-control product" value="${item.product}"></td>
            <td><input class="form-control hsn" value="${item.hsn}"></td>
            <td><input class="form-control discount" type="number" value="${item.discount}"></td>
            <td><input class="form-control qty" type="number" value="${item.qty}"></td>
            <td><input class="form-control mrp" type="number" value="${item.mrp}"></td>
            <td><input class="form-control gst" type="number" value="${item.gstPercent}"></td>
            <td><input class="form-control rate" readonly></td>
            <td><input class="form-control amt" readonly></td>
            <td><input class="form-control sgst" readonly></td>
            <td><input class="form-control cgst" readonly></td>
            <td><input class="form-control igst" readonly></td>
            <td><input class="form-control total" readonly></td>
        `;
        tbody.appendChild(row);
        calculateRow(row);
    });

    recalculateTotals();
});

// Recalculate each row
function calculateRow(row) {
    const qty = parseFloat(row.querySelector(".qty").value) || 0;
    const mrp = parseFloat(row.querySelector(".mrp").value) || 0;
    const gstPercent = parseFloat(row.querySelector(".gst").value) || 0;
    const discount = parseFloat(row.querySelector(".discount").value) || 0;

    const rateNoGST = mrp / (1 + gstPercent / 100);
    const discountedRate = rateNoGST * (1 - discount / 100);
    const amountNoGST = discountedRate * qty;

    const gstAmt = amountNoGST * gstPercent / 100;
    const isIGST = document.getElementById("igstcheck").checked;

    const sgst = isIGST ? 0 : gstAmt / 2;
    const cgst = isIGST ? 0 : gstAmt / 2;
    const igst = isIGST ? gstAmt : 0;
    const totalWithGST = amountNoGST + gstAmt;

    row.querySelector(".rate").value = discountedRate.toFixed(2);
    row.querySelector(".amt").value = amountNoGST.toFixed(2);
    row.querySelector(".sgst").value = sgst.toFixed(2);
    row.querySelector(".cgst").value = cgst.toFixed(2);
    row.querySelector(".igst").value = igst.toFixed(2);
    row.querySelector(".total").value = totalWithGST.toFixed(2);
}

// Recalculate totals across all rows
function recalculateTotals() {
    const rows = document.querySelectorAll("#items-body tr");
    let totalWithoutGST = 0, totalSGST = 0, totalCGST = 0, totalIGST = 0, totalWithGST = 0;

    rows.forEach(row => {
        totalWithoutGST += parseFloat(row.querySelector(".amt").value) || 0;
        totalSGST += parseFloat(row.querySelector(".sgst").value) || 0;
        totalCGST += parseFloat(row.querySelector(".cgst").value) || 0;
        totalIGST += parseFloat(row.querySelector(".igst").value) || 0;
        totalWithGST += parseFloat(row.querySelector(".total").value) || 0;
    });

    document.querySelector("input[name='invoice-total-amt-without-gst']").value = totalWithoutGST.toFixed(2);
    document.querySelector("input[name='invoice-total-amt-sgst']").value = totalSGST.toFixed(2);
    document.querySelector("input[name='invoice-total-amt-cgst']").value = totalCGST.toFixed(2);
    document.querySelector("input[name='invoice-total-amt-igst']").value = totalIGST.toFixed(2);
    document.querySelector("input[name='invoice-total-amt-with-gst']").value = totalWithGST.toFixed(2);
}

// === Events for Recalculating ===
document.getElementById("items-body").addEventListener("input", function (e) {
    const row = e.target.closest("tr");
    if (row) {
        calculateRow(row);
        recalculateTotals();
    }
});

document.getElementById("igstcheck").addEventListener("change", () => {
    document.querySelectorAll("#items-body tr").forEach(row => calculateRow(row));
    recalculateTotals();
});
</script>
{% endblock %}
