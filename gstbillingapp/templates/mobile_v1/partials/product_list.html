{% load humanize %}

{% if products %}
    {% for product in products %}
    <div class="product-item">
        <div class="product-icon">
            <i class="bi bi-box-seam"></i>
        </div>
        <div class="product-details">
            <div class="product-header">
                <div class="product-top-section">
                    <div class="product-info-wrapper">
                        <span class="product-model">{{ product.model_no }}</span>
                        {% if product.product_name %}
                        <span class="product-name">{{ product.product_name }}</span>
                        {% endif %}
                    </div>
                    <div class="product-price-wrapper">
                        {% if product.product_discount > 0 %}
                        <span class="product-price-original">₹{{ product.product_rate_with_gst|floatformat:2|intcomma }}</span>
                        <span class="product-price discount-price">₹{{ product.final_price_with_gst|floatformat:2|intcomma }}</span>
                        <span class="product-price-discount">₹{{ product.discounted_base_price|floatformat:2|intcomma }}</span>
                        {% else %}
                        <span class="product-price">₹{{ product.product_rate_with_gst|floatformat:2|intcomma }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="product-meta-badges">
                    {% if product.current_stock is not None %}
                    <span class="product-badge stock-badge {% if product.current_stock == 0 %}out-of-stock{% elif product.is_low_stock %}low-stock{% else %}in-stock{% endif %}" onclick="addInventoryStock('{{ product.user.id }}', '{{ product.model_no }}', '{{ product.alert_level }}', '{{ product.current_stock }}')">
                        <i class="bi bi-box"></i> Stock: {{ product.current_stock|intcomma }}
                        {% if product.alert_level %}
                        / Alert: {{ product.alert_level|intcomma }}
                        {% endif %}
                        {% if product.is_low_stock %}
                        <i class="bi bi-exclamation-triangle-fill" style="margin-left: 2px;"></i>
                        {% endif %}
                    </span>
                    {% endif %}
                    {% if product.product_hsn %}
                    <span class="product-badge hsn-badge">
                        <i class="bi bi-hash"></i> {{ product.product_hsn }}
                    </span>
                    {% endif %}
                    <span class="product-badge gst-badge">
                        <i class="bi bi-percent"></i> GST {{ product.product_gst_percentage }}%
                    </span>
                    {% if product.product_discount > 0 %}
                    <span class="product-badge discount-badge">
                        <i class="bi bi-tag"></i> {{ product.product_discount }}% OFF
                    </span>
                    {% endif %}
                    {% if product.user %}
                    <span class="product-badge user-badge">
                        <i class="bi bi-person-circle"></i> {{ product.user.userprofile.business_brand|default:product.user.username }}
                    </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
    
    <!-- Pagination -->
    {% if products.has_other_pages %}
    <div class="pagination-container">
        <button class="pagination-btn" {% if products.has_previous %}onclick="loadProducts({{ products.previous_page_number }})"{% endif %} {% if not products.has_previous %}disabled{% endif %}>
            <i class="bi bi-chevron-left"></i> Previous
        </button>
        <span class="pagination-info">Page {{ products.number }} of {{ products.paginator.num_pages }}</span>
        <button class="pagination-btn" {% if products.has_next %}onclick="loadProducts({{ products.next_page_number }})"{% endif %} {% if not products.has_next %}disabled{% endif %}>
            Next <i class="bi bi-chevron-right"></i>
        </button>
    </div>
    {% endif %}
{% else %}
    <div class="empty-state">
        <div class="empty-state-icon">
            <i class="bi bi-box-seam"></i>
        </div>
        <h3 class="empty-state-title">No Products Found</h3>
        <p class="empty-state-text">Try adjusting your search or filters</p>
    </div>
{% endif %}

<script>
function addInventoryStock(brand, modelNo, stock_alert, current_stock) {
    Swal.fire({
        title: "Add Stock",
        html: `
        <input type="number" id="added_stock" class="swal2-input" placeholder="Enter stock quantity (${current_stock})"
            style="height:38px;font-size:14px;width:85%;margin:6px auto;" min="1">
        <p style="font-size:14px;color:#555;">Enter Stock for Model No: <strong>${modelNo}</strong></p>
        <input type="number" id="stock_alert" class="swal2-input" placeholder="Stock alert level (optional)" 
            style="height:38px;font-size:14px;width:85%;margin:6px auto;" value="${stock_alert}" min="1">
        <p style="font-size:14px;color:#555;">Enter Stock Alert Level</strong></p>
        <label style="font-size:14px;display:flex;align-items:center;justify-content:center;gap:6px;">
            <input type="checkbox" id="reduce_stock">Reduce stock</label>
        <label style="font-size:14px;display:flex;align-items:center;justify-content:center;gap:6px;">
            <input type="checkbox" id="only_alert">Only Alert</label>
        `,
        focusConfirm: false,
        showCancelButton: true,
        confirmButtonText: "Add Stock",
        cancelButtonText: "Cancel",
        confirmButtonColor: "#3085d6",
        preConfirm: () => {
            const addedStock = document.getElementById("added_stock").value;
            const stockAlert = document.getElementById("stock_alert").value;
            const reduce_stock = document.getElementById("reduce_stock").checked;
            const only_alert = document.getElementById("only_alert").checked;
            const title = new URLSearchParams(window.location.search).get("title") || "";

            if (!addedStock || addedStock <= 0) {
                Swal.showValidationMessage("Please enter a valid stock quantity");
                return false;
            }

            return {
                added_stock: addedStock,
                stock_alert: stockAlert,
                reduce_stock: reduce_stock,
                only_alert: only_alert,
                title: title
            };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`{% url 'v1productinventorystockaddapi' %}?brand=${brand}&model_no=${modelNo}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: `added_stock=${result.value.added_stock}&stock_alert=${result.value.stock_alert}&reduce_stock=${result.value.reduce_stock}&only_alert=${result.value.only_alert}&title=${result.value.title}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    Swal.fire("Success!", data.message, "success")
                        .then(() => location.reload());
                } else {
                    Swal.fire("Error", data.message, "error");
                }
            })
            .catch(() => {
                Swal.fire("Error", "Something went wrong!", "error");
            });
        }
    });
}
</script>
