<nav class="mobile-bottom-nav d-md-none">
    <div class="nav-scroll">

        <!-- Home -->
        <a href="{% url 'v1home' %}?u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}" class="nav-item" data-page="home">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>

        <!-- Invoices -->
        <a href="{% url 'v1invoices' %}?u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}" class="nav-item" data-page="invoices">
            <i class="fas fa-file-invoice"></i>
            <span>Invoices</span>
        </a>
        
        <!-- Books -->
        <a href="{% url 'v1books' %}?u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}" class="nav-item" data-page="books">
            <i class="fas fa-book-open"></i>
            <span>Books</span>
        </a>

        <!-- Customers -->
        <a href="{% url 'v1customers' %}?u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}" class="nav-item" data-page="customers">
            <i class="fas fa-users"></i>
            <span>Customers</span>
        </a>

        <!-- Products -->
        <a href="{% url 'v1products' %}?u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}" class="nav-item" data-page="products">
            <i class="fas fa-box"></i>
            <span>Products</span>
        </a>
        
        <!-- Orders (Admin) -->
        <a href="{% url 'v1adminorders' %}?u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}" class="nav-item" data-page="orders">
            <i class="fas fa-clipboard-list"></i>
            <span>Orders</span>
        </a>
        
        <!-- Notifications -->
        <a href="{% url 'v1notifications' %}?u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}" class="nav-item" data-page="notifications">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
            <span class="notification-badge" id="mobile-notification-badge" style="display: none;"></span>
        </a>
        
        {% if request.GET.admin == "true" %}
        <!-- Expenses Tracker -->
        <a href="{% url 'v1expensestracker' %}?u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}" class="nav-item" data-page="expensestracker">
            <i class="fas fa-wallet"></i>
            <span>Expenses</span>
        </a>

        <!-- Purchase Logs -->
        <a href="{% url 'v1purchaselogs' %}?u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}" class="nav-item" data-page="purchaselogs">
            <i class="fas fa-shopping-cart"></i>
            <span>Purchase Logs</span>
        </a>
        {% endif %}
    </div>
</nav>

<style>
    .nav-item {
        position: relative;
    }
    
    .notification-badge {
        position: absolute;
        top: 4px;
        right: 8px;
        background: #ff3b30;
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 700;
        min-width: 18px;
        text-align: center;
    }
</style>

<script>
    // Add All With users_filter={{ request.GET.users_filter }}&u={{ request.GET.u }}
    document.querySelectorAll('.nav-item').forEach(item => {
        const url = new URL(item.href);
        url.searchParams.set('users_filter', '{{ request.GET.users_filter }}');
        item.href = url.toString();
    });
    
    // Highlight active nav item based on current URL
    document.addEventListener('DOMContentLoaded', function() {
        const currentPath = window.location.pathname;
        const navItems = document.querySelectorAll('.nav-item');
        let activeItem = null;
        
        navItems.forEach(item => {
            const page = item.dataset.page;
            
            // Remove active class first
            item.classList.remove('active');
            
            // Check for exact page matches (employee URLs)
            if (page === 'home' && currentPath.endsWith('/home')) {
                item.classList.add('active');
                activeItem = item;
            } else if (page === 'invoices' && currentPath.endsWith('/invoices')) {
                item.classList.add('active');
                activeItem = item;
            } else if (page === 'books' && currentPath.endsWith('/books')) {
                item.classList.add('active');
                activeItem = item;
            } else if (page === 'customers' && currentPath.endsWith('/customers')) {
                item.classList.add('active');
                activeItem = item;
            } else if (page === 'products' && currentPath.endsWith('/products')) {
                item.classList.add('active');
                activeItem = item;
            } else if (page === 'notifications' && currentPath.endsWith('/notifications')) {
                item.classList.add('active');
                activeItem = item;
            } else if (page === 'expensestracker' && currentPath.endsWith('/expensestracker')) {
                item.classList.add('active');
                activeItem = item;
            } else if (page === 'purchaselogs' && currentPath.endsWith('/purchaselogs')) {
                item.classList.add('active');
                activeItem = item;
            }
        });
        
        // Scroll active item into view
        if (activeItem) {
            setTimeout(() => {
                activeItem.scrollIntoView({
                    behavior: 'smooth',
                    block: 'nearest',
                    inline: 'center'
                });
            }, 100);
        }
    });
    
    // WebSocket for real-time notification count
    let mobileWs = null;
    let mobileReconnectInterval = null;
    
    function connectMobileNotificationWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/notifications/`;
        
        mobileWs = new WebSocket(wsUrl);
        
        mobileWs.onopen = function() {
            console.log('Mobile notification WebSocket connected');
            if (mobileReconnectInterval) {
                clearInterval(mobileReconnectInterval);
                mobileReconnectInterval = null;
            }
            updateNotificationBadge();
        };
        
        mobileWs.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'notification' || data.type === 'count_update') {
                updateNotificationBadge();
            }
        };
        
        mobileWs.onerror = function(error) {
            console.error('Mobile WebSocket error:', error);
        };
        
        mobileWs.onclose = function() {
            console.log('Mobile WebSocket disconnected, reconnecting...');
            mobileReconnectInterval = setInterval(connectMobileNotificationWebSocket, 5000);
        };
    }
    
    function updateNotificationBadge() {
        const userId = '{{ request.GET.u }}';
        if (!userId) return;
        
        fetch(`/mobile/v1/api/notifications/count?user_id=${userId}`)
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('mobile-notification-badge');
                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            })
            .catch(error => console.error('Error fetching notification count:', error));
    }
    
    // Connect on page load
    connectMobileNotificationWebSocket();
</script>
