<nav class="mobile-bottom-nav d-md-none">
    <div class="nav-scroll">

        <!-- Home -->
        <a href="{% url 'v1customerhome' %}?cid={{ request.GET.cid }}" class="nav-item" data-page="home">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>

        <!-- Invoices -->
        <a href="{% url 'v1customerinvoices' %}?cid={{ request.GET.cid }}" class="nav-item" data-page="invoices">
            <i class="fas fa-file-invoice"></i>
            <span>Invoices</span>
        </a>
        
        <!-- Books -->
        <a href="{% url 'v1customerbooks' %}?cid={{ request.GET.cid }}" class="nav-item" data-page="books">
            <i class="fas fa-book-open"></i>
            <span>Books</span>
        </a>

        <!-- Notifications -->
        <a href="{% url 'v1customernotifications' %}?cid={{ request.GET.cid }}" class="nav-item" data-page="notifications">
            <i class="fas fa-bell"></i>
            <span>Notifications</span>
            <span class="notification-badge" id="mobile-notification-badge" style="display: none;"></span>
        </a>

        <!-- Profile -->
        <a href="{% url 'v1customerprofile' %}?cid={{ request.GET.cid }}" class="nav-item" data-page="profile">
            <i class="fas fa-user-circle"></i>
            <span>Profile</span>
        </a>

        {% if request.GET.u == "emp" %}
        <!-- Customers -->
        <a href="{% url 'v1customers' %}" class="nav-item" data-page="customers">
            <i class="fas fa-users"></i>
            <span>Customers</span>
        </a>
        {% endif %}
    </div>
</nav>

<style>
    .nav-item {
        position: relative;
    }
    
    .notification-badge {
        position: absolute;
        top: 4px;
        right: 8px;
        background: #ff3b30;
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 700;
        min-width: 18px;
        text-align: center;
    }
</style>

<script>
    // Add All With users_filter={{ request.GET.users_filter }}&u={{ request.GET.u }}
    document.querySelectorAll('.nav-item').forEach(item => {
        const url = new URL(item.href);
        url.searchParams.set('users_filter', '{{ request.GET.users_filter }}');
        url.searchParams.set('u', '{{ request.GET.u }}');
        url.searchParams.set('cid', '{{ request.GET.cid }}');
        url.searchParams.set('admin', '{{ request.GET.admin }}');
        item.href = url.toString();
    });
    
    // Highlight active nav item based on current URL
    document.addEventListener('DOMContentLoaded', function() {
        const currentPath = window.location.pathname;
        const navItems = document.querySelectorAll('.nav-item');
        
        navItems.forEach(item => {
            const page = item.dataset.page;
            
            // Remove active class first
            item.classList.remove('active');
            
            // Check for exact page matches
            if (page === 'home' && currentPath.includes('customer/home')) {
                item.classList.add('active');
            } else if (page === 'invoices' && currentPath.includes('customer/invoices')) {
                item.classList.add('active');
            } else if (page === 'books' && currentPath.includes('customer/books')) {
                item.classList.add('active');
            } else if (page === 'notifications' && currentPath.includes('customer/notifications')) {
                item.classList.add('active');
            } else if (page === 'profile' && currentPath.includes('customer/profile') && 
                       !currentPath.includes('home') && 
                       !currentPath.includes('invoices') && 
                       !currentPath.includes('books') &&
                       !currentPath.includes('notifications')) {
                item.classList.add('active');
            }
        });
    });
    
    // WebSocket for real-time notification count
    let mobileWs = null;
    let mobileReconnectInterval = null;
    
    function connectMobileNotificationWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/notifications/`;
        
        mobileWs = new WebSocket(wsUrl);
        
        mobileWs.onopen = function() {
            console.log('Mobile notification WebSocket connected');
            if (mobileReconnectInterval) {
                clearInterval(mobileReconnectInterval);
                mobileReconnectInterval = null;
            }
            updateNotificationBadge();
        };
        
        mobileWs.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.type === 'notification' || data.type === 'count_update') {
                updateNotificationBadge();
            }
        };
        
        mobileWs.onerror = function(error) {
            console.error('Mobile WebSocket error:', error);
        };
        
        mobileWs.onclose = function() {
            console.log('Mobile WebSocket disconnected, reconnecting...');
            mobileReconnectInterval = setInterval(connectMobileNotificationWebSocket, 5000);
        };
    }
    
    function updateNotificationBadge() {
        // Extract user ID from cid parameter
        const urlParams = new URLSearchParams(window.location.search);
        const cid = urlParams.get('cid');
        if (!cid) return;
        
        // Parse the cid to get user ID (format: GS-<user_id>-C-<customer_id>)
        const matches = cid.match(/GS-(\d+)-/);
        if (!matches) return;
        
        const userId = matches[1];
        
        fetch(`/mobile/v1/api/notifications/count?user_id=${userId}`)
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('mobile-notification-badge');
                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            })
            .catch(error => console.error('Error fetching notification count:', error));
    }
    
    // Connect on page load
    connectMobileNotificationWebSocket();
</script>
