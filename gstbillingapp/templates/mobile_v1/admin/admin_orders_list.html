{% extends "mobile_v1/base.html" %}
{% load static %}

{% block title %}Manage Orders{% endblock %}

{% block extra_css %}
<style>
    /* Force dropdown items to be visible in dark mode - highest specificity */
    [data-theme="dark"] .dropdown-menu .dropdown-item,
    [data-theme="dark"] .btn-group .dropdown-menu .dropdown-item,
    [data-theme="dark"] .dropdown-item {
        color: #ffffff !important;
        background-color: transparent !important;
    }
    
    [data-theme="dark"] .dropdown-menu .dropdown-item:hover,
    [data-theme="dark"] .dropdown-menu .dropdown-item:focus,
    [data-theme="dark"] .btn-group .dropdown-menu .dropdown-item:hover,
    [data-theme="dark"] .btn-group .dropdown-menu .dropdown-item:focus,
    [data-theme="dark"] .dropdown-item:hover,
    [data-theme="dark"] .dropdown-item:focus {
        background-color: #2c2c2e !important;
        color: #ffffff !important;
    }
    
    /* Ensure colored icons remain visible */
    [data-theme="dark"] .dropdown-item .text-warning,
    [data-theme="dark"] .dropdown-item .text-success,
    [data-theme="dark"] .dropdown-item .text-info,
    [data-theme="dark"] .dropdown-item .text-primary,
    [data-theme="dark"] .dropdown-item .text-secondary {
        opacity: 1 !important;
    }
    
    /* Override any link color inheritance */
    [data-theme="dark"] a.dropdown-item {
        color: #ffffff !important;
    }
    
    [data-theme="dark"] a.dropdown-item:hover,
    [data-theme="dark"] a.dropdown-item:focus {
        color: #ffffff !important;
    }
</style>
{% endblock %}

{% block content %}
<style>
    /* Ultra-specific dark mode dropdown fix - loaded after base styles */
    html[data-theme="dark"] .container-fluid .btn-group .dropdown-menu .dropdown-item,
    html[data-theme="dark"] .container-fluid .dropdown-menu .dropdown-item,
    html[data-theme="dark"] body .dropdown-menu a.dropdown-item {
        color: #ffffff !important;
    }
    
    html[data-theme="dark"] .container-fluid .btn-group .dropdown-menu .dropdown-item:hover,
    html[data-theme="dark"] .container-fluid .dropdown-menu .dropdown-item:hover,
    html[data-theme="dark"] body .dropdown-menu a.dropdown-item:hover {
        background-color: #2c2c2e !important;
        color: #ffffff !important;
    }
</style>

<div class="container-fluid px-3 py-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="fas fa-clipboard-list"></i> Manage Orders</h4>
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-primary dropdown-toggle" data-toggle="dropdown">
                <i class="fas fa-filter"></i> Filter
            </button>
            <div class="dropdown-menu dropdown-menu-right">
                <a class="dropdown-item" href="?status=all&u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}"><i class="fas fa-list"></i> All Orders</a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="?status=DRAFT&u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}"><i class="fas fa-clock text-warning"></i> Pending</a>
                <a class="dropdown-item" href="?status=APPROVED&u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}"><i class="fas fa-check text-success"></i> Approved</a>
                <a class="dropdown-item" href="?status=PROCESSING&u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}"><i class="fas fa-cog text-info"></i> Processing</a>
                <a class="dropdown-item" href="?status=PACKED&u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}"><i class="fas fa-box text-primary"></i> Packed</a>
                <a class="dropdown-item" href="?status=SHIPPED&u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}"><i class="fas fa-shipping-fast text-primary"></i> Shipped</a>
                <a class="dropdown-item" href="?status=OUT_FOR_DELIVERY&u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}"><i class="fas fa-truck text-info"></i> Out for Delivery</a>
                <a class="dropdown-item" href="?status=DELIVERED&u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}"><i class="fas fa-check-circle text-success"></i> Delivered</a>
                <a class="dropdown-item" href="?status=CONVERTED&u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}"><i class="fas fa-file-invoice-dollar text-secondary"></i> Completed</a>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-3">
        <div class="col-4">
            <div class="card shadow-sm border-warning">
                <div class="card-body p-2 text-center">
                    <small class="text-muted d-block">Pending</small>
                    <h5 class="mb-0 text-warning">{{ status_counts.DRAFT|default:0 }}</h5>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card shadow-sm border-info">
                <div class="card-body p-2 text-center">
                    <small class="text-muted d-block">Processing</small>
                    <h5 class="mb-0 text-info">{{ processing_count|default:0 }}</h5>
                </div>
            </div>
        </div>
        <div class="col-4">
            <div class="card shadow-sm border-success">
                <div class="card-body p-2 text-center">
                    <small class="text-muted d-block">Delivered</small>
                    <h5 class="mb-0 text-success">{{ status_counts.DELIVERED|default:0 }}</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Box -->
    <div class="form-group mb-3">
        <div class="input-group">
            <div class="input-group-prepend">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
            </div>
            <input type="text" class="form-control" id="search-input" placeholder="Search by order #, customer name...">
        </div>
    </div>
    
    {% if quotations_list %}
        {% for item in quotations_list %}
        <div class="card shadow-sm mb-3 order-item" 
             data-order="{{ item.quotation.quotation_number }}" 
             data-customer="{{ item.customer_name|lower }}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <i class="fas fa-file-invoice"></i> 
                            Order #{{ item.quotation.quotation_number }}
                        </h6>
                        <small class="text-muted d-block">
                            <i class="fas fa-user"></i> {{ item.customer_name }}
                        </small>
                        <small class="text-primary d-block font-weight-bold">
                            <i class="fas fa-store"></i> {{ item.business_brand }}
                        </small>
                        <small class="text-muted d-block">
                            <i class="far fa-calendar"></i> 
                            {{ item.quotation.quotation_date|date:"d M Y" }}
                        </small>
                    </div>
                    
                    <div class="text-right">
                        {% if item.quotation.status == 'DRAFT' %}
                            <span class="badge badge-warning d-block mb-1"><i class="fas fa-clock"></i> Pending</span>
                        {% elif item.quotation.status == 'APPROVED' %}
                            <span class="badge badge-success d-block mb-1"><i class="fas fa-check"></i> Approved</span>
                        {% elif item.quotation.status == 'PROCESSING' %}
                            <span class="badge badge-info d-block mb-1"><i class="fas fa-cog fa-spin"></i> Processing</span>
                        {% elif item.quotation.status == 'PACKED' %}
                            <span class="badge badge-primary d-block mb-1"><i class="fas fa-box"></i> Packed</span>
                        {% elif item.quotation.status == 'SHIPPED' %}
                            <span class="badge badge-primary d-block mb-1"><i class="fas fa-shipping-fast"></i> Shipped</span>
                        {% elif item.quotation.status == 'OUT_FOR_DELIVERY' %}
                            <span class="badge badge-info d-block mb-1"><i class="fas fa-truck"></i> Out for Delivery</span>
                        {% elif item.quotation.status == 'DELIVERED' %}
                            <span class="badge badge-success d-block mb-1"><i class="fas fa-check-circle"></i> Delivered</span>
                        {% elif item.quotation.status == 'CONVERTED' %}
                            <span class="badge badge-secondary d-block mb-1"><i class="fas fa-file-invoice-dollar"></i> Completed</span>
                        {% endif %}
                        
                        {% if item.quotation.created_by_customer %}
                        <span class="badge badge-info badge-sm"><i class="fas fa-mobile-alt"></i> Customer Order</span>
                        {% endif %}
                    </div>
                </div>
                
                <hr class="my-2">
                
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">
                        <i class="fas fa-box"></i> {{ item.item_count }} item{{ item.item_count|pluralize }} 
                        <span class="badge badge-secondary ml-1">Qty: {{ item.total_qty|floatformat:0 }}</span>
                    </small>
                    <span class="text-primary font-weight-bold">
                        â‚¹{{ item.total_amount|floatformat:2 }}
                    </span>
                </div>
                
                {% if item.quotation.notes %}
                <div class="alert alert-light py-1 px-2 mb-2" style="font-size: 12px;">
                    <i class="fas fa-sticky-note"></i> <strong>Notes:</strong> {{ item.quotation.notes }}
                </div>
                {% endif %}
                
                <div class="btn-toolbar" role="toolbar">
                    <div class="btn-group btn-group-sm mr-2 mb-2" role="group">
                        <a href="{% url 'v1adminorderdetail' item.quotation.id %}?u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}" 
                           class="btn btn-outline-primary">
                            <i class="fas fa-eye"></i> View
                        </a>
                        
                        {% if item.quotation.status == 'DRAFT' and request.GET.admin == "true" %}
                        <a href="{% url 'v1adminorderedit' item.quotation.id %}?u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}" 
                           class="btn btn-outline-warning">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        {% endif %}
                    </div>
                    
                    {% if item.quotation.status != 'CONVERTED' and item.quotation.status != 'DELIVERED' %}
                    <div class="btn-group btn-group-sm mr-2 mb-2" role="group">
                        <button type="button" class="btn btn-outline-info dropdown-toggle" data-toggle="dropdown">
                            <i class="fas fa-tasks"></i> Update Status
                        </button>
                        <div class="dropdown-menu">
                            {% if item.quotation.status == 'DRAFT' %}
                            <a class="dropdown-item" href="#" onclick="updateStatus({{ item.quotation.id }}, 'APPROVED'); return false;">
                                <i class="fas fa-check text-success"></i> Approve Order
                            </a>
                            {% endif %}
                            
                            {% if item.quotation.status in 'DRAFT,APPROVED' %}
                            <a class="dropdown-item" href="#" onclick="updateStatus({{ item.quotation.id }}, 'PROCESSING'); return false;">
                                <i class="fas fa-cog text-info"></i> Mark as Processing
                            </a>
                            {% endif %}
                            
                            {% if item.quotation.status in 'APPROVED,PROCESSING' %}
                            <a class="dropdown-item" href="#" onclick="updateStatus({{ item.quotation.id }}, 'PACKED'); return false;">
                                <i class="fas fa-box text-primary"></i> Mark as Packed
                            </a>
                            {% endif %}
                            
                            {% if item.quotation.status in 'PROCESSING,PACKED' %}
                            <a class="dropdown-item" href="#" onclick="updateStatus({{ item.quotation.id }}, 'SHIPPED'); return false;">
                                <i class="fas fa-shipping-fast text-primary"></i> Mark as Shipped
                            </a>
                            {% endif %}
                            
                            {% if item.quotation.status == 'SHIPPED' %}
                            <a class="dropdown-item" href="#" onclick="updateStatus({{ item.quotation.id }}, 'OUT_FOR_DELIVERY'); return false;">
                                <i class="fas fa-truck text-info"></i> Out for Delivery
                            </a>
                            {% endif %}
                            
                            {% if item.quotation.status in 'SHIPPED,OUT_FOR_DELIVERY' %}
                            <a class="dropdown-item" href="#" onclick="updateStatus({{ item.quotation.id }}, 'DELIVERED'); return false;">
                                <i class="fas fa-check-circle text-success"></i> Mark as Delivered
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if item.quotation.can_be_converted and request.GET.admin == "true" %}
                    <div class="btn-group btn-group-sm mb-2" role="group">
                        <button onclick="convertToInvoice({{ item.quotation.id }}, {{ item.quotation.quotation_number }})" 
                                class="btn btn-success">
                            <i class="fas fa-file-invoice-dollar"></i> Convert to Invoice
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
        
        <!-- Load More Button (if needed) -->
        {% if has_more %}
        <div class="text-center mt-3">
            <button class="btn btn-outline-primary" onclick="loadMore()">
                <i class="fas fa-chevron-down"></i> Load More
            </button>
        </div>
        {% endif %}
    {% else %}
        <div class="text-center py-5">
            <i class="fas fa-clipboard-list fa-4x text-muted mb-3"></i>
            <h5 class="text-muted mb-3">No orders found</h5>
            {% if current_filter and current_filter != 'all' %}
            <p class="text-muted">No orders with status: <strong>{{ current_filter }}</strong></p>
            <a href="{% url 'v1adminorders' %}?u={{ request.GET.u }}&admin={{ request.GET.admin }}&users_filter={{ request.GET.users_filter }}" class="btn btn-primary">
                <i class="fas fa-list"></i> View All Orders
            </a>
            {% else %}
            <p class="text-muted">Orders will appear here once customers place them</p>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
// Search functionality
document.getElementById('search-input').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const orderItems = document.querySelectorAll('.order-item');
    
    orderItems.forEach(item => {
        const orderNum = item.getAttribute('data-order');
        const customerName = item.getAttribute('data-customer');
        
        if (orderNum.includes(searchTerm) || customerName.includes(searchTerm)) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
});

// Update order status
function updateStatus(quotationId, newStatus) {
    const statusNames = {
        'APPROVED': 'Approved',
        'PROCESSING': 'Processing',
        'PACKED': 'Packed',
        'SHIPPED': 'Shipped',
        'OUT_FOR_DELIVERY': 'Out for Delivery',
        'DELIVERED': 'Delivered'
    };
    
    Swal.fire({
        title: 'Update Order Status',
        text: `Change status to: ${statusNames[newStatus]}?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#17a2b8',
        cancelButtonColor: '#6c757d',
        confirmButtonText: 'Yes, update it!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            // Show loading
            Swal.fire({
                title: 'Updating...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`{% url 'v1adminorderupdatestatus' 0 %}`.replace('0', quotationId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    'new_status': newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Status Updated!',
                        text: data.message,
                        confirmButtonColor: '#28a745'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to update status. Please try again.',
                    confirmButtonColor: '#dc3545'
                });
            });
        }
    });
}

// Convert to invoice
function convertToInvoice(quotationId, quotationNumber) {
    Swal.fire({
        title: 'Convert to Invoice',
        html: `Convert Order #${quotationNumber} to Invoice?<br><small class="text-muted">This action will create an invoice and update inventory.</small>`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#28a745',
        cancelButtonColor: '#6c757d',
        confirmButtonText: '<i class="fas fa-check"></i> Yes, Convert',
        cancelButtonText: 'Cancel',
        input: 'textarea',
        inputLabel: 'Invoice Notes (Optional)',
        inputPlaceholder: 'Add any notes for this invoice...',
        inputAttributes: {
            'aria-label': 'Invoice notes'
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // Show loading
            Swal.fire({
                title: 'Converting...',
                text: 'Please wait while we create the invoice',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            // Get CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch(`{% url 'v1adminorderconvert' 0 %}`.replace('0', quotationId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: new URLSearchParams({
                    'notes': result.value || ''
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Invoice Created!',
                        html: `<p>${data.message}</p><small class="text-muted">Invoice #${data.invoice_number}</small>`,
                        confirmButtonColor: '#28a745',
                        confirmButtonText: 'View Invoice'
                    }).then(() => {
                        window.location.href = data.invoice_url;
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                        confirmButtonColor: '#dc3545'
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to convert to invoice. Please try again.',
                    confirmButtonColor: '#dc3545'
                });
            });
        }
    });
}
</script>

{% csrf_token %}
{% endblock %}
