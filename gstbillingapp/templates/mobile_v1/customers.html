{% extends 'mobile_v1/base.html' %}

{% block title %}Customers - GST Sync{% endblock %}

{% block includecss %}
<style>
    /* Samsung One UI Design System */
    :root {
        --oneui-primary: #667eea;
        --oneui-primary-dark: #5568d3;
        --oneui-secondary: #764ba2;
        --oneui-accent: #34c759;
        --oneui-warning: #ff9500;
        --oneui-danger: #ff3b30;
        --oneui-bg: #f5f5f7;
        --oneui-surface: #ffffff;
        --oneui-text-primary: #1c1c1e;
        --oneui-text-secondary: #8e8e93;
        --oneui-divider: #d1d1d6;
        --oneui-shadow: 0 2px 16px rgba(0, 0, 0, 0.08);
        --oneui-shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
        --oneui-radius: 16px;
        --oneui-radius-sm: 12px;
        --gradient-header: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    * { -webkit-tap-highlight-color: transparent; }
    
    body {
        background: var(--oneui-bg);
        min-height: 100vh;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        padding-bottom: 80px;
        margin: 0;
    }
    
    /* Header */
    .header-section {
        background: var(--gradient-header);
        color: white;
        padding: 20px 0;
        box-shadow: var(--oneui-shadow-lg);
        position: sticky;
        top: 0;
        z-index: 1000;
    }
    
    .header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
    }
    
    .header-icon-circle {
        width: 48px;
        height: 48px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .header-text h1 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0 0 4px 0;
    }
    
    .header-text p {
        margin: 0;
        font-size: 0.875rem;
        opacity: 0.9;
    }
    
    .header-stats {
        display: flex;
        gap: 16px;
    }
    
    .stat-item {
        text-align: center;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 10px;
    }
    
    .stat-number {
        display: block;
        font-size: 1.25rem;
        font-weight: 700;
    }
    
    .stat-label {
        display: block;
        font-size: 0.688rem;
        opacity: 0.8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    /* Filter Section */
    .filter-section {
        background: white;
        padding: 16px;
        box-shadow: var(--oneui-shadow);
        margin-bottom: 16px;
        border-radius: var(--oneui-radius-sm);
    }
    
    .filter-row {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
    }
    
    .filter-row:last-child {
        margin-bottom: 0;
    }
    
    .form-group {
        flex: 1;
        position: relative;
    }
    
    .form-label {
        display: block;
        font-size: 0.813rem;
        font-weight: 600;
        color: var(--oneui-text-secondary);
        margin-bottom: 6px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--oneui-divider);
        border-radius: var(--oneui-radius-sm);
        background: white;
        font-size: 0.938rem;
        font-weight: 500;
        color: var(--oneui-text-primary);
        transition: all 0.2s;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238e8e93' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        padding-right: 36px;
    }
    
    .form-select:focus {
        outline: none;
        border-color: var(--oneui-primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .search-wrapper {
        position: relative;
        flex: 1;
    }
    
    .search-input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 2px solid var(--oneui-divider);
        border-radius: var(--oneui-radius-sm);
        font-size: 0.938rem;
        transition: all 0.2s;
    }
    
    .search-input:focus {
        outline: none;
        border-color: var(--oneui-primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--oneui-text-secondary);
        pointer-events: none;
    }
    
    .clear-search {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: var(--oneui-text-secondary);
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        padding: 0;
        font-size: 0.75rem;
    }
    
    .clear-search.active {
        display: flex;
    }
    
    /* Customer List */
    .customer-list-container {
        padding: 0 16px;
    }
    
    .customer-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 16px;
        background: white;
        border-radius: var(--oneui-radius-sm);
        box-shadow: var(--oneui-shadow);
        margin-bottom: 12px;
        text-decoration: none;
        color: inherit;
        transition: all 0.2s;
        border: 1px solid transparent;
    }
    
    .customer-item:active {
        transform: scale(0.98);
        box-shadow: 0 1px 8px rgba(0, 0, 0, 0.06);
        border-color: rgba(102, 126, 234, 0.2);
    }
    
    .customer-item-unactive {
        opacity: 0.6;
        background: var(--oneui-bg);
    }
    
    .customer-icon {
        width: 48px;
        height: 48px;
        background: linear-gradient(135deg, #667eea15, #764ba215);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }
    
    .customer-icon i {
        font-size: 1.5rem;
        color: var(--oneui-primary);
    }
    
    .customer-details {
        flex: 1;
        min-width: 0;
    }
    
    .customer-name {
        font-size: 1rem;
        font-weight: 600;
        color: var(--oneui-text-primary);
        margin-bottom: 4px;
    }
    
    .customer-meta {
        font-size: 0.813rem;
        color: var(--oneui-text-secondary);
        display: flex;
        align-items: center;
        gap: 4px;
        margin-bottom: 2px;
    }
    
    .customer-meta i {
        font-size: 0.75rem;
    }
    
    .customer-badge {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.688rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: #f3e5f5;
        color: #7b1fa2;
        margin-top: 4px;
    }
    
    .customer-arrow {
        color: var(--oneui-text-secondary);
        transition: transform 0.2s ease;
        font-size: 1rem;
    }
    
    .customer-item:active .customer-arrow {
        transform: translateX(3px);
        color: var(--oneui-primary);
    }
    
    /* Pagination */
    .pagination-container {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        padding: 20px 16px;
        margin-top: 16px;
    }
    
    .pagination-btn {
        padding: 10px 16px;
        border: 2px solid var(--oneui-divider);
        border-radius: 10px;
        background: white;
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--oneui-text-primary);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .pagination-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }
    
    .pagination-btn:not(:disabled):active {
        transform: scale(0.95);
    }
    
    .pagination-info {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--oneui-text-secondary);
        padding: 0 12px;
    }
    
    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }
    
    .empty-state-icon {
        width: 80px;
        height: 80px;
        background: var(--oneui-bg);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
    }
    
    .empty-state-icon i {
        font-size: 2.5rem;
        color: var(--oneui-text-secondary);
    }
    
    .empty-state-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--oneui-text-primary);
        margin-bottom: 8px;
    }
    
    .empty-state-text {
        font-size: 0.938rem;
        color: var(--oneui-text-secondary);
    }
    
    /* Loading Spinner */
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }
    
    .loading-spinner.active {
        display: block;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid var(--oneui-divider);
        border-top-color: var(--oneui-primary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin: 0 auto;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    /* Dark Mode */
    [data-theme="dark"] {
        --oneui-bg: #000000;
        --oneui-surface: #1c1c1e;
        --oneui-text-primary: #ffffff;
        --oneui-text-secondary: #8e8e93;
        --oneui-divider: #38383a;
    }
    
    [data-theme="dark"] .filter-section,
    [data-theme="dark"] .customer-item {
        background: var(--oneui-surface);
        border-color: var(--oneui-divider);
    }
    
    [data-theme="dark"] .form-select,
    [data-theme="dark"] .search-input {
        background: var(--oneui-surface);
        border-color: var(--oneui-divider);
        color: var(--oneui-text-primary);
    }
    
    [data-theme="dark"] .pagination-btn {
        background: var(--oneui-surface);
        border-color: var(--oneui-divider);
        color: var(--oneui-text-primary);
    }
    
    [data-theme="dark"] .customer-item-unactive {
        background: rgba(28, 28, 30, 0.5);
    }
    
    @media (max-width: 576px) {
        .header-stats {
            flex-direction: column;
            gap: 8px;
        }
        
        .stat-item {
            padding: 6px 10px;
        }
        
        .stat-number {
            font-size: 1rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="header-section">
    <div class="container-fluid">
        <div class="header-content">
            <div class="d-flex align-items-center gap-3">
                <div class="header-icon-circle">
                    <i class="bi bi-people fs-4"></i>
                </div>
                <div class="header-text">
                    <h1>Customers</h1>
                    <p>Manage your customer base</p>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalCustomers">{{ total_count|default:0 }}</span>
                    <span class="stat-label">Customers</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter Section -->
<div class="container-fluid mt-3">
    <div class="filter-section">
        <div class="filter-row">
            <div class="form-group">
                <label class="form-label" for="userSelect">
                    <i class="bi bi-building"></i> Filter by User
                </label>
                <select class="form-select" id="userSelect">
                    <option value="">All Users</option>
                    {% for user in users %}
                    <option value="{{ user.user.id }}" 
                            {% if current_user_id == user.user.id|stringformat:'s' %}selected{% endif %}
                            data-count="{{ user.customer_count }}">
                        {{ user.business_brand }} ({{ user.customer_count }})
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="filter-row">
            <div class="search-wrapper">
                <i class="bi bi-search search-icon"></i>
                <input type="text" 
                       class="search-input" 
                       id="searchInput" 
                       placeholder="Search by name, phone, GST, email..." 
                       value="{{ current_search }}">
                <button class="clear-search" id="clearSearch">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Customer List -->
    <div class="customer-list-container" id="customerList">
        {% include 'mobile_v1/partials/customer_list.html' %}
    </div>
    
    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <p class="mt-3 text-secondary">Loading customers...</p>
    </div>
    
    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <div class="pagination-container">
        <button class="pagination-btn" 
                id="prevBtn" 
                {% if not page_obj.has_previous %}disabled{% endif %}>
            <i class="bi bi-chevron-left"></i>
            Previous
        </button>
        <span class="pagination-info">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>
        <button class="pagination-btn" 
                id="nextBtn" 
                {% if not page_obj.has_next %}disabled{% endif %}>
            Next
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>
    {% endif %}
</div>

<!-- EMPLOYEE NAVBAR -->
{% include "mobile_v1/navbarE.html" %}

{% endblock %}

{% block includejs %}
<script>
    // State Management
    let currentPage = {{ page_obj.number|default:1 }};
    let userId = '{{ current_user_id }}';
    let searchQuery = '{{ current_search }}';
    let usersFilter = '{{ users_filter }}';
    let searchTimeout = null;
    
    // DOM Elements
    const userSelect = document.getElementById('userSelect');
    const searchInput = document.getElementById('searchInput');
    const clearSearchBtn = document.getElementById('clearSearch');
    const customerList = document.getElementById('customerList');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        updateClearButton();
    });
    
    // Setup Event Listeners
    function setupEventListeners() {
        // User Selection
        userSelect.addEventListener('change', function() {
            userId = this.value;
            currentPage = 1;
            loadCustomers();
        });
        
        // Search with Debounce
        searchInput.addEventListener('input', function() {
            updateClearButton();
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                searchQuery = this.value.trim();
                currentPage = 1;
                loadCustomers();
            }, 300);
        });
        
        // Clear Search
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            searchQuery = '';
            currentPage = 1;
            updateClearButton();
            loadCustomers();
        });
        
        // Pagination
        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadCustomers();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            });
        }
        
        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                currentPage++;
                loadCustomers();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        }
    }
    
    // Load Customers via AJAX
    function loadCustomers() {
        // Show loading
        loadingSpinner.classList.add('active');
        customerList.style.opacity = '0.5';
        
        // Build URL params
        const params = new URLSearchParams({
            page: currentPage,
            user_id: userId,
            users_filter: usersFilter,
            search: searchQuery
        });
        
        // Fetch data
        fetch(`?${params.toString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Update customer list
            customerList.innerHTML = data.html;
            customerList.style.opacity = '1';
            
            // Update stats
            document.getElementById('totalCustomers').textContent = data.total_count;
            
            // Update pagination
            updatePagination(data);
            
            // Hide loading
            loadingSpinner.classList.remove('active');
        })
        .catch(error => {
            console.error('Error loading customers:', error);
            loadingSpinner.classList.remove('active');
            customerList.style.opacity = '1';
        });
    }
    
    // Update Pagination Controls
    function updatePagination(data) {
        const paginationContainer = document.querySelector('.pagination-container');
        
        if (data.total_pages <= 1) {
            if (paginationContainer) paginationContainer.style.display = 'none';
            return;
        }
        
        if (paginationContainer) paginationContainer.style.display = 'flex';
        
        if (prevBtn) {
            prevBtn.disabled = !data.has_previous;
        }
        
        if (nextBtn) {
            nextBtn.disabled = !data.has_next;
        }
        
        const paginationInfo = document.querySelector('.pagination-info');
        if (paginationInfo) {
            paginationInfo.textContent = `Page ${data.current_page} of ${data.total_pages}`;
        }
    }
    
    // Update Clear Search Button Visibility
    function updateClearButton() {
        if (searchInput.value.trim().length > 0) {
            clearSearchBtn.classList.add('active');
        } else {
            clearSearchBtn.classList.remove('active');
        }
    }
    
    // Haptic Feedback (if supported)
    function triggerHaptic() {
        if ('vibrate' in navigator) {
            navigator.vibrate(10);
        }
    }
</script>
{% endblock %}
