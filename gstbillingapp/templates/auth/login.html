{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="row">
<div class="col-sm">
</div>
<div class="col-sm">
	<div class="card" id="login-card">
		<h5 class="card-header">GST SYNC</h5>
		<div class="card-body">
			<h5 class="card-title">Login and start billing now!</h5>
		</div>
		<form method="POST">
			{% csrf_token %}
			<table class="table">
				<tbody class="two-col-form">
					<tr>
						<th scope="row" class="text-right">Username:</th>
						<td class="form-input-td">{{auth_form.username}}</td>
					</tr>`
					<tr>
						<th scope="row" class="text-right">Password:</th>
						<td class="form-input-td">{{auth_form.password}}</td>
					</tr>
				</tbody>
			</table>

			<div class="text-right" style="margin-bottom: 5px;margin-right: 5px;">
				<button type="submit" class="btn btn-primary"><i class="fas fa-right-to-bracket"></i></button>
				<a href="#" class="btn btn-success" onclick="passkey()"><i class="fas fa-key"></i></a>
				{% if admin %}
					<a href="#" class="btn btn-danger" onclick="signUp()"><i class="fas fa-user-plus"></i></a>
				{% endif %}
			</div>
		</form>
	</div>
</div>
<div class="col-sm">
</div>
</div>

<script>
	{% if admin %}
		function signUp() {
			Swal.fire({
				title: 'Redirecting to Sign Up page',
				text: 'You will be redirected to the Sign Up page.',
				icon: 'info',
				confirmButtonText: 'OK'
			}).then((result) => {
				if (result.isConfirmed) {
					window.location.href = "{% url 'signup_view' %}";
				}
			});
		};
	{% endif %}
	function passkey() {
		Swal.fire({
			title: 'Passkey Authentication',
			html: `
				<p>Please enter your 5-digit alphanumeric PIN</p>
				<div style="display: flex; justify-content: center; gap: 10px; margin: 20px 0;">
					<input type="password" id="pin1" maxlength="1" style="width: 40px; height: 40px; text-align: center; font-size: 18px; text-transform: uppercase; border: 2px solid #ddd; border-radius: 5px;">
					<input type="password" id="pin2" maxlength="1" style="width: 40px; height: 40px; text-align: center; font-size: 18px; text-transform: uppercase; border: 2px solid #ddd; border-radius: 5px;">
					<input type="password" id="pin3" maxlength="1" style="width: 40px; height: 40px; text-align: center; font-size: 18px; text-transform: uppercase; border: 2px solid #ddd; border-radius: 5px;">
					<input type="password" id="pin4" maxlength="1" style="width: 40px; height: 40px; text-align: center; font-size: 18px; text-transform: uppercase; border: 2px solid #ddd; border-radius: 5px;">
					<input type="password" id="pin5" maxlength="1" style="width: 40px; height: 40px; text-align: center; font-size: 18px; text-transform: uppercase; border: 2px solid #ddd; border-radius: 5px;">
				</div>
			`,
			icon: 'warning',
			showCancelButton: true,
			showConfirmButton: false,
			cancelButtonText: 'Cancel',
			didOpen: () => {
				const inputs = ['pin1', 'pin2', 'pin3', 'pin4', 'pin5'];
				
				const authenticatePin = () => {
					const passkey = inputs.map(id => document.getElementById(id).value).join('');
					
					if (passkey.length === 5 && /^[A-Z0-9]{5}$/.test(passkey)) {
                    fetch('/api/passkey-auth', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({ passkey: passkey })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            Swal.fire('Error', data.error, 'error');
                        } else {
                            Swal.fire('Success!', data.message, 'success')
                                .then(() => window.location.reload());
                        }
                    })
                    .catch(error => {
                        Swal.fire('Error', 'Authentication failed: ' + error.message, 'error');
                    });
                }
            };
				
				inputs.forEach((id, index) => {
					const input = document.getElementById(id);
					input.addEventListener('input', (e) => {
						e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
						if (e.target.value && index < 4) {
							document.getElementById(inputs[index + 1]).focus();
						} else if (e.target.value && index === 4) {
							authenticatePin();
						}
					});
					input.addEventListener('keydown', (e) => {
						if (e.key === 'Backspace' && !e.target.value && index > 0) {
							document.getElementById(inputs[index - 1]).focus();
						}
					});
				});
				document.getElementById('pin1').focus();
			}
		});
	};
</script>
{% endblock %}
